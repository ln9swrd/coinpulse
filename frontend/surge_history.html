<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>급등예측 이력 - 코인펄스 관리자</title>
    <link rel="stylesheet" href="css/internal-pages.css">
    <style>
        /* Surge History specific styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
        }

        .back-link {
            color: white;
            text-decoration: none;
            font-size: 14px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            transition: background 0.3s;
        }

        .back-link:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Content */
        .content {
            padding: 40px;
        }

        /* Stats Cards - Clean & Visible */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            color: #2d3748;
            padding: 32px 28px;
            border-radius: 20px;
            border-left: 6px solid #667eea;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            position: relative;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        /* Different border colors for different stat types */
        .stat-card:nth-child(1) {
            border-left-color: #667eea;
        }

        .stat-card:nth-child(2) {
            border-left-color: #f56565;
        }

        .stat-card:nth-child(3) {
            border-left-color: #4299e1;
        }

        .stat-card:nth-child(4) {
            border-left-color: #48bb78;
        }

        .stat-card:nth-child(5) {
            border-left-color: #ed8936;
        }

        .stat-card:nth-child(6) {
            border-left-color: #9f7aea;
        }

        .stat-label {
            font-size: 15px;
            color: #718096;
            margin-bottom: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
        }

        .stat-icon {
            font-size: 24px;
        }

        .stat-value {
            font-size: 48px;
            font-weight: 800;
            line-height: 1.2;
            color: #1a202c;
        }

        .stat-card:nth-child(4) .stat-value {
            color: #48bb78;
        }

        .stat-unit {
            font-size: 22px;
            color: #718096;
            margin-left: 6px;
            font-weight: 600;
        }

        /* Filters */
        .filters {
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
        }

        .filters h3 {
            margin-bottom: 16px;
            color: #333;
        }

        .filter-grid {
            display: flex;
            gap: 12px;
            flex-wrap: nowrap;
            overflow-x: auto;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
            flex-shrink: 0;
        }

        .filter-group label {
            font-size: 14px;
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .filter-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        /* Table */
        .table-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #e9ecef;
        }

        .table-header h3 {
            color: #333;
            font-size: 18px;
        }

        .table-actions {
            display: flex;
            gap: 12px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8f9fa;
        }

        th {
            padding: 16px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
        }

        td {
            padding: 16px;
            border-top: 1px solid #e9ecef;
            font-size: 14px;
            color: #333;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 24px;
        }

        .page-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .page-btn:hover:not(:disabled) {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .page-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 60px;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #f3f4f6;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error State */
        .error-state {
            text-align: center;
            padding: 60px 20px;
        }

        .error-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .error-state h3 {
            margin-bottom: 8px;
            color: #333;
        }

        .error-state p {
            color: #666;
            font-size: 14px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .filter-grid {
                /* Keep single row with horizontal scroll on mobile */
                gap: 8px;
            }

            .filter-group {
                min-width: 120px;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 12px 8px;
            }
        }
    </style>
    <script src="js/error-handler.js?v=20251227"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>📊 급등예측 이력 관리</h1>
            <a href="dashboard.html#admin" class="back-link">← 관리자 대시보드로 돌아가기</a>
        </header>

        <div class="content">
            <!-- Statistics Cards - Enhanced Visibility -->
            <div class="stats-grid" id="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">
                        <span class="stat-icon">📊</span>
                        전체 예측
                    </div>
                    <div class="stat-value" id="stat-total">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">
                        <span class="stat-icon">🤖</span>
                        자동거래
                    </div>
                    <div class="stat-value" id="stat-auto-traded">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">
                        <span class="stat-icon">🎯</span>
                        평균 신뢰도
                    </div>
                    <div class="stat-value" id="stat-confidence">-<span class="stat-unit">%</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">
                        <span class="stat-icon">💰</span>
                        총 손익
                    </div>
                    <div class="stat-value" id="stat-profit">-<span class="stat-unit">원</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">
                        <span class="stat-icon">✅</span>
                        수익 거래
                    </div>
                    <div class="stat-value" id="stat-profitable">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">
                        <span class="stat-icon">❌</span>
                        손실 거래
                    </div>
                    <div class="stat-value" id="stat-losing">-</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters">
                <h3>🔍 필터</h3>
                <div class="filter-grid">
                    <div class="filter-group">
                        <label>마켓</label>
                        <select id="filter-market">
                            <option value="">전체</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>신호 유형</label>
                        <select id="filter-signal-type">
                            <option value="">전체</option>
                            <option value="surge">Surge</option>
                            <option value="breakout">Breakout</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>자동거래</label>
                        <select id="filter-auto-traded">
                            <option value="">전체</option>
                            <option value="true">자동거래</option>
                            <option value="false">수동</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>상태</label>
                        <select id="filter-status">
                            <option value="">전체</option>
                            <option value="pending">Pending (진행중)</option>
                            <option value="win">Win (수익)</option>
                            <option value="lose">Lose (손실)</option>
                            <option value="backtest">Backtest (백테스트)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>시작일</label>
                        <input type="date" id="filter-start-date">
                    </div>
                    <div class="filter-group">
                        <label>종료일</label>
                        <input type="date" id="filter-end-date">
                    </div>
                </div>
                <div class="filter-actions">
                    <button class="btn btn-primary" onclick="applyFilters()">필터 적용</button>
                    <button class="btn btn-secondary" onclick="resetFilters()">초기화</button>
                    <button class="btn btn-secondary" onclick="exportCSV()">CSV 내보내기</button>
                </div>
            </div>

            <!-- Table -->
            <div class="table-container">
                <div class="table-header">
                    <h3>급등예측 내역</h3>
                    <div class="table-actions">
                        <select id="per-page" onchange="changePerPage()">
                            <option value="50">50개씩</option>
                            <option value="100">100개씩</option>
                            <option value="200">200개씩</option>
                            <option value="500">500개씩</option>
                        </select>
                    </div>
                </div>

                <div id="table-content">
                    <!-- Table will be loaded here -->
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>

                <div class="pagination" id="pagination">
                    <!-- Pagination will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Note: api_client.js is already loaded by dashboard.html, no need to load again -->
    <script>
    (function() {
        'use strict';

        // Coin information mapping (All 230 Upbit KRW markets)
        const COIN_INFO = {
            'WAXP': { name: '왁스', logo: 'https://cryptoicon-api.pages.dev/api/icon/waxp' },
            'CARV': { name: '카브', logo: 'https://cryptoicon-api.pages.dev/api/icon/carv' },
            'LSK': { name: '리스크', logo: 'https://cryptoicon-api.pages.dev/api/icon/lsk' },
            '0G': { name: '제로지', logo: 'https://cryptoicon-api.pages.dev/api/icon/0g' },
            'BORA': { name: '보라', logo: 'https://cryptoicon-api.pages.dev/api/icon/bora' },
            'PUNDIX': { name: '펀디엑스', logo: 'https://cryptoicon-api.pages.dev/api/icon/pundix' },
            'USD1': { name: '월드리버티파이낸셜유에스디', logo: 'https://cryptoicon-api.pages.dev/api/icon/usd1' },
            'BAT': { name: '베이직어텐션토큰', logo: 'https://cryptoicon-api.pages.dev/api/icon/bat' },
            'HUNT': { name: '헌트', logo: 'https://cryptoicon-api.pages.dev/api/icon/hunt' },
            'PENGU': { name: '펏지펭귄', logo: 'https://cryptoicon-api.pages.dev/api/icon/pengu' },
            'FIL': { name: '파일코인', logo: 'https://cryptoicon-api.pages.dev/api/icon/fil' },
            'BEAM': { name: '빔', logo: 'https://cryptoicon-api.pages.dev/api/icon/beam' },
            'DOOD': { name: '두들즈', logo: 'https://cryptoicon-api.pages.dev/api/icon/dood' },
            'WAVES': { name: '웨이브', logo: 'https://cryptoicon-api.pages.dev/api/icon/waves' },
            'USDC': { name: '유에스디코인', logo: 'https://cryptoicon-api.pages.dev/api/icon/usdc' },
            'MOVE': { name: '무브먼트', logo: 'https://cryptoicon-api.pages.dev/api/icon/move' },
            'TREE': { name: '트리하우스', logo: 'https://cryptoicon-api.pages.dev/api/icon/tree' },
            'AERGO': { name: '아르고', logo: 'https://cryptoicon-api.pages.dev/api/icon/aergo' },
            'WET': { name: '휴미디파이', logo: 'https://cryptoicon-api.pages.dev/api/icon/wet' },
            'USDT': { name: '테더', logo: 'https://cryptoicon-api.pages.dev/api/icon/usdt' },
            '2Z': { name: '더블제로', logo: 'https://cryptoicon-api.pages.dev/api/icon/2z' },
            'BOUNTY': { name: '체인바운티', logo: 'https://cryptoicon-api.pages.dev/api/icon/bounty' },
            'KAITO': { name: '카이토', logo: 'https://cryptoicon-api.pages.dev/api/icon/kaito' },
            'LPT': { name: '라이브피어', logo: 'https://cryptoicon-api.pages.dev/api/icon/lpt' },
            'BLAST': { name: '블라스트', logo: 'https://cryptoicon-api.pages.dev/api/icon/blast' },
            'DKA': { name: '디카르고', logo: 'https://cryptoicon-api.pages.dev/api/icon/dka' },
            'ANKR': { name: '앵커', logo: 'https://cryptoicon-api.pages.dev/api/icon/ankr' },
            'ALGO': { name: '알고랜드', logo: 'https://cryptoicon-api.pages.dev/api/icon/algo' },
            'SHIB': { name: '시바이누', logo: 'https://cryptoicon-api.pages.dev/api/icon/shib' },
            'UNI': { name: '유니스왑', logo: 'https://cryptoicon-api.pages.dev/api/icon/uni' },
            'BIO': { name: '바이오프로토콜', logo: 'https://cryptoicon-api.pages.dev/api/icon/bio' },
            'WLFI': { name: '월드리버티파이낸셜', logo: 'https://cryptoicon-api.pages.dev/api/icon/wlfi' },
            'TOKAMAK': { name: '토카막네트워크', logo: 'https://cryptoicon-api.pages.dev/api/icon/tokamak' },
            'CYBER': { name: '사이버', logo: 'https://cryptoicon-api.pages.dev/api/icon/cyber' },
            'DOGE': { name: '도지코인', logo: 'https://cryptoicon-api.pages.dev/api/icon/doge' },
            'WLD': { name: '월드코인', logo: 'https://cryptoicon-api.pages.dev/api/icon/wld' },
            'PEPE': { name: '페페', logo: 'https://cryptoicon-api.pages.dev/api/icon/pepe' },
            'HBAR': { name: '헤데라', logo: 'https://cryptoicon-api.pages.dev/api/icon/hbar' },
            'BCH': { name: '비트코인캐시', logo: 'https://cryptoicon-api.pages.dev/api/icon/bch' },
            'NEWT': { name: '뉴턴프로토콜', logo: 'https://cryptoicon-api.pages.dev/api/icon/newt' },
            'SEI': { name: '세이', logo: 'https://cryptoicon-api.pages.dev/api/icon/sei' },
            'BONK': { name: '봉크', logo: 'https://cryptoicon-api.pages.dev/api/icon/bonk' },
            'JST': { name: '저스트', logo: 'https://cryptoicon-api.pages.dev/api/icon/jst' },
            'AAVE': { name: '에이브', logo: 'https://cryptoicon-api.pages.dev/api/icon/aave' },
            'JTO': { name: '지토', logo: 'https://cryptoicon-api.pages.dev/api/icon/jto' },
            'JUP': { name: '주피터', logo: 'https://cryptoicon-api.pages.dev/api/icon/jup' },
            'FLOW': { name: '플로우', logo: 'https://cryptoicon-api.pages.dev/api/icon/flow' },
            'ALT': { name: '알트레이어', logo: 'https://cryptoicon-api.pages.dev/api/icon/alt' },
            'LAYER': { name: '솔레이어', logo: 'https://cryptoicon-api.pages.dev/api/icon/layer' },
            'TRX': { name: '트론', logo: 'https://cryptoicon-api.pages.dev/api/icon/trx' },
            'POWR': { name: '파워렛저', logo: 'https://cryptoicon-api.pages.dev/api/icon/powr' },
            'ATOM': { name: '코스모스', logo: 'https://cryptoicon-api.pages.dev/api/icon/atom' },
            'ARKM': { name: '아캄', logo: 'https://cryptoicon-api.pages.dev/api/icon/arkm' },
            'CRO': { name: '크로노스', logo: 'https://cryptoicon-api.pages.dev/api/icon/cro' },
            'NXPC': { name: '넥스페이스', logo: 'https://cryptoicon-api.pages.dev/api/icon/nxpc' },
            'A': { name: '볼타', logo: 'https://cryptoicon-api.pages.dev/api/icon/a' },
            'TRUMP': { name: '오피셜트럼프', logo: 'https://cryptoicon-api.pages.dev/api/icon/trump' },
            'F': { name: '신퓨처스', logo: 'https://cryptoicon-api.pages.dev/api/icon/f' },
            'G': { name: '그래비티', logo: 'https://cryptoicon-api.pages.dev/api/icon/g' },
            'CELO': { name: '셀로', logo: 'https://cryptoicon-api.pages.dev/api/icon/celo' },
            'AERO': { name: '에어로드롬파이낸스', logo: 'https://cryptoicon-api.pages.dev/api/icon/aero' },
            'CTC': { name: '크레딧코인', logo: 'https://cryptoicon-api.pages.dev/api/icon/ctc' },
            'ANIME': { name: '애니메코인', logo: 'https://cryptoicon-api.pages.dev/api/icon/anime' },
            'APT': { name: '앱토스', logo: 'https://cryptoicon-api.pages.dev/api/icon/apt' },
            'MOCA': { name: '모카네트워크', logo: 'https://cryptoicon-api.pages.dev/api/icon/moca' },
            'API3': { name: '에이피아이쓰리', logo: 'https://cryptoicon-api.pages.dev/api/icon/api3' },
            'AHT': { name: '아하토큰', logo: 'https://cryptoicon-api.pages.dev/api/icon/aht' },
            'EGLD': { name: '멀티버스엑스', logo: 'https://cryptoicon-api.pages.dev/api/icon/egld' },
            'ERA': { name: '칼데라', logo: 'https://cryptoicon-api.pages.dev/api/icon/era' },
            'FF': { name: '팔콘파이낸스', logo: 'https://cryptoicon-api.pages.dev/api/icon/ff' },
            'PLUME': { name: '플룸', logo: 'https://cryptoicon-api.pages.dev/api/icon/plume' },
            'NEO': { name: '네오', logo: 'https://cryptoicon-api.pages.dev/api/icon/neo' },
            'ETC': { name: '이더리움클래식', logo: 'https://cryptoicon-api.pages.dev/api/icon/etc' },
            'IOTA': { name: '아이오타', logo: 'https://cryptoicon-api.pages.dev/api/icon/iota' },
            'IOST': { name: '아이오에스티', logo: 'https://cryptoicon-api.pages.dev/api/icon/iost' },
            'AKT': { name: '아카시네트워크', logo: 'https://cryptoicon-api.pages.dev/api/icon/akt' },
            'COW': { name: '카우프로토콜', logo: 'https://cryptoicon-api.pages.dev/api/icon/cow' },
            'VIRTUAL': { name: '버추얼프로토콜', logo: 'https://cryptoicon-api.pages.dev/api/icon/virtual' },
            'ETH': { name: '이더리움', logo: 'https://cryptoicon-api.pages.dev/api/icon/eth' },
            'IQ': { name: '아이큐', logo: 'https://cryptoicon-api.pages.dev/api/icon/iq' },
            'IP': { name: '스토리', logo: 'https://cryptoicon-api.pages.dev/api/icon/ip' },
            'NEAR': { name: '니어프로토콜', logo: 'https://cryptoicon-api.pages.dev/api/icon/near' },
            'RVN': { name: '레이븐코인', logo: 'https://cryptoicon-api.pages.dev/api/icon/rvn' },
            'AGLD': { name: '어드벤처골드', logo: 'https://cryptoicon-api.pages.dev/api/icon/agld' },
            'ID': { name: '스페이스아이디', logo: 'https://cryptoicon-api.pages.dev/api/icon/id' },
            'IN': { name: '인피닛', logo: 'https://cryptoicon-api.pages.dev/api/icon/in' },
            'NOM': { name: '노미나', logo: 'https://cryptoicon-api.pages.dev/api/icon/nom' },
            'WAL': { name: '월러스', logo: 'https://cryptoicon-api.pages.dev/api/icon/wal' },
            'PENDLE': { name: '펜들', logo: 'https://cryptoicon-api.pages.dev/api/icon/pendle' },
            'BLUR': { name: '블러', logo: 'https://cryptoicon-api.pages.dev/api/icon/blur' },
            'AWE': { name: '에이더블유이', logo: 'https://cryptoicon-api.pages.dev/api/icon/awe' },
            'THETA': { name: '쎄타토큰', logo: 'https://cryptoicon-api.pages.dev/api/icon/theta' },
            'AXL': { name: '엑셀라', logo: 'https://cryptoicon-api.pages.dev/api/icon/axl' },
            'HP': { name: '히포프로토콜', logo: 'https://cryptoicon-api.pages.dev/api/icon/hp' },
            'SAND': { name: '샌드박스', logo: 'https://cryptoicon-api.pages.dev/api/icon/sand' },
            'WCT': { name: '월렛커넥트', logo: 'https://cryptoicon-api.pages.dev/api/icon/wct' },
            'YGG': { name: '일드길드게임즈', logo: 'https://cryptoicon-api.pages.dev/api/icon/ygg' },
            'AXS': { name: '엑시인피니티', logo: 'https://cryptoicon-api.pages.dev/api/icon/axs' },
            'ARDR': { name: '아더', logo: 'https://cryptoicon-api.pages.dev/api/icon/ardr' },
            'AQT': { name: '알파쿼크', logo: 'https://cryptoicon-api.pages.dev/api/icon/aqt' },
            'ME': { name: '매직에덴', logo: 'https://cryptoicon-api.pages.dev/api/icon/me' },
            'TRUST': { name: '인튜이션', logo: 'https://cryptoicon-api.pages.dev/api/icon/trust' },
            'SONIC': { name: '소닉SVM', logo: 'https://cryptoicon-api.pages.dev/api/icon/sonic' },
            'ARB': { name: '아비트럼', logo: 'https://cryptoicon-api.pages.dev/api/icon/arb' },
            'POL': { name: '폴리곤에코시스템토큰', logo: 'https://cryptoicon-api.pages.dev/api/icon/pol' },
            'CVC': { name: '시빅', logo: 'https://cryptoicon-api.pages.dev/api/icon/cvc' },
            'T': { name: '쓰레스홀드', logo: 'https://cryptoicon-api.pages.dev/api/icon/t' },
            'W': { name: '웜홀', logo: 'https://cryptoicon-api.pages.dev/api/icon/w' },
            'ARK': { name: '아크', logo: 'https://cryptoicon-api.pages.dev/api/icon/ark' },
            'AVNT': { name: '아반티스', logo: 'https://cryptoicon-api.pages.dev/api/icon/avnt' },
            'LA': { name: '라그랑주', logo: 'https://cryptoicon-api.pages.dev/api/icon/la' },
            'HYPER': { name: '하이퍼레인', logo: 'https://cryptoicon-api.pages.dev/api/icon/hyper' },
            'ATH': { name: '에이셔', logo: 'https://cryptoicon-api.pages.dev/api/icon/ath' },
            'TAIKO': { name: '타이코', logo: 'https://cryptoicon-api.pages.dev/api/icon/taiko' },
            'AVAX': { name: '아발란체', logo: 'https://cryptoicon-api.pages.dev/api/icon/avax' },
            'CPOOL': { name: '클리어풀', logo: 'https://cryptoicon-api.pages.dev/api/icon/cpool' },
            'IMX': { name: '이뮤터블엑스', logo: 'https://cryptoicon-api.pages.dev/api/icon/imx' },
            'SC': { name: '시아코인', logo: 'https://cryptoicon-api.pages.dev/api/icon/sc' },
            'INJ': { name: '인젝티브', logo: 'https://cryptoicon-api.pages.dev/api/icon/inj' },
            'MVL': { name: '엠블', logo: 'https://cryptoicon-api.pages.dev/api/icon/mvl' },
            'HIVE': { name: '하이브', logo: 'https://cryptoicon-api.pages.dev/api/icon/hive' },
            'CBK': { name: '코박토큰', logo: 'https://cryptoicon-api.pages.dev/api/icon/cbk' },
            'OM': { name: '만트라', logo: 'https://cryptoicon-api.pages.dev/api/icon/om' },
            'XLM': { name: '스텔라루멘', logo: 'https://cryptoicon-api.pages.dev/api/icon/xlm' },
            'OP': { name: '옵티미즘', logo: 'https://cryptoicon-api.pages.dev/api/icon/op' },
            'SAFE': { name: '세이프', logo: 'https://cryptoicon-api.pages.dev/api/icon/safe' },
            'GLM': { name: '골렘', logo: 'https://cryptoicon-api.pages.dev/api/icon/glm' },
            'SUPER': { name: '슈퍼버스', logo: 'https://cryptoicon-api.pages.dev/api/icon/super' },
            'LINEA': { name: '리네아', logo: 'https://cryptoicon-api.pages.dev/api/icon/linea' },
            'KERNEL': { name: '커널다오', logo: 'https://cryptoicon-api.pages.dev/api/icon/kernel' },
            'POKT': { name: '포켓네트워크', logo: 'https://cryptoicon-api.pages.dev/api/icon/pokt' },
            'ZKC': { name: '바운드리스', logo: 'https://cryptoicon-api.pages.dev/api/icon/zkc' },
            'KNC': { name: '카이버네트워크', logo: 'https://cryptoicon-api.pages.dev/api/icon/knc' },
            'AUCTION': { name: '바운스토큰', logo: 'https://cryptoicon-api.pages.dev/api/icon/auction' },
            'ORDER': { name: '오덜리', logo: 'https://cryptoicon-api.pages.dev/api/icon/order' },
            'DRIFT': { name: '드리프트', logo: 'https://cryptoicon-api.pages.dev/api/icon/drift' },
            'FCT2': { name: '피르마체인', logo: 'https://cryptoicon-api.pages.dev/api/icon/fct2' },
            'MTL': { name: '메탈', logo: 'https://cryptoicon-api.pages.dev/api/icon/mtl' },
            'VET': { name: '비체인', logo: 'https://cryptoicon-api.pages.dev/api/icon/vet' },
            'QTUM': { name: '퀀텀', logo: 'https://cryptoicon-api.pages.dev/api/icon/qtum' },
            'TT': { name: '썬더코어', logo: 'https://cryptoicon-api.pages.dev/api/icon/tt' },
            'LINK': { name: '체인링크', logo: 'https://cryptoicon-api.pages.dev/api/icon/link' },
            'XRP': { name: '엑스알피(리플)', logo: 'https://cryptoicon-api.pages.dev/api/icon/xrp' },
            'CHZ': { name: '칠리즈', logo: 'https://cryptoicon-api.pages.dev/api/icon/chz' },
            'ASTR': { name: '아스타', logo: 'https://cryptoicon-api.pages.dev/api/icon/astr' },
            'STORJ': { name: '스토리지', logo: 'https://cryptoicon-api.pages.dev/api/icon/storj' },
            'ENA': { name: '에테나', logo: 'https://cryptoicon-api.pages.dev/api/icon/ena' },
            'MANA': { name: '디센트럴랜드', logo: 'https://cryptoicon-api.pages.dev/api/icon/mana' },
            'OPEN': { name: '오픈렛저', logo: 'https://cryptoicon-api.pages.dev/api/icon/open' },
            'GRS': { name: '그로스톨코인', logo: 'https://cryptoicon-api.pages.dev/api/icon/grs' },
            'PYTH': { name: '피스네트워크', logo: 'https://cryptoicon-api.pages.dev/api/icon/pyth' },
            'ENS': { name: '이더리움네임서비스', logo: 'https://cryptoicon-api.pages.dev/api/icon/ens' },
            'GRT': { name: '더그래프', logo: 'https://cryptoicon-api.pages.dev/api/icon/grt' },
            'PUMP': { name: '펌프펀', logo: 'https://cryptoicon-api.pages.dev/api/icon/pump' },
            'XTZ': { name: '테조스', logo: 'https://cryptoicon-api.pages.dev/api/icon/xtz' },
            'CKB': { name: '너보스', logo: 'https://cryptoicon-api.pages.dev/api/icon/ckb' },
            'KAVA': { name: '카바', logo: 'https://cryptoicon-api.pages.dev/api/icon/kava' },
            'TOSHI': { name: '토시', logo: 'https://cryptoicon-api.pages.dev/api/icon/toshi' },
            'BARD': { name: '롬바드', logo: 'https://cryptoicon-api.pages.dev/api/icon/bard' },
            'ZRO': { name: '레이어제로', logo: 'https://cryptoicon-api.pages.dev/api/icon/zro' },
            'RAY': { name: '레이디움', logo: 'https://cryptoicon-api.pages.dev/api/icon/ray' },
            'ONDO': { name: '온도파이낸스', logo: 'https://cryptoicon-api.pages.dev/api/icon/ondo' },
            'ZRX': { name: '제로엑스', logo: 'https://cryptoicon-api.pages.dev/api/icon/zrx' },
            'GMT': { name: '스테픈', logo: 'https://cryptoicon-api.pages.dev/api/icon/gmt' },
            'TFUEL': { name: '쎄타퓨엘', logo: 'https://cryptoicon-api.pages.dev/api/icon/tfuel' },
            'XPL': { name: '플라즈마', logo: 'https://cryptoicon-api.pages.dev/api/icon/xpl' },
            'MASK': { name: '마스크네트워크', logo: 'https://cryptoicon-api.pages.dev/api/icon/mask' },
            'COMP': { name: '컴파운드', logo: 'https://cryptoicon-api.pages.dev/api/icon/comp' },
            'ZETA': { name: '제타체인', logo: 'https://cryptoicon-api.pages.dev/api/icon/zeta' },
            'RED': { name: '레드스톤', logo: 'https://cryptoicon-api.pages.dev/api/icon/red' },
            'TIA': { name: '셀레스티아', logo: 'https://cryptoicon-api.pages.dev/api/icon/tia' },
            'ADA': { name: '에이다', logo: 'https://cryptoicon-api.pages.dev/api/icon/ada' },
            'ELF': { name: '엘프', logo: 'https://cryptoicon-api.pages.dev/api/icon/elf' },
            'STEEM': { name: '스팀', logo: 'https://cryptoicon-api.pages.dev/api/icon/steem' },
            'SOPH': { name: '소폰', logo: 'https://cryptoicon-api.pages.dev/api/icon/soph' },
            'MED': { name: '메디블록', logo: 'https://cryptoicon-api.pages.dev/api/icon/med' },
            '1INCH': { name: '1인치네트워크', logo: 'https://cryptoicon-api.pages.dev/api/icon/1inch' },
            'MEW': { name: '캣인어독스월드', logo: 'https://cryptoicon-api.pages.dev/api/icon/mew' },
            'ORBS': { name: '오브스', logo: 'https://cryptoicon-api.pages.dev/api/icon/orbs' },
            'RENDER': { name: '렌더토큰', logo: 'https://cryptoicon-api.pages.dev/api/icon/render' },
            'STG': { name: '스타게이트파이낸스', logo: 'https://cryptoicon-api.pages.dev/api/icon/stg' },
            'ORCA': { name: '오르카', logo: 'https://cryptoicon-api.pages.dev/api/icon/orca' },
            'BERA': { name: '베라체인', logo: 'https://cryptoicon-api.pages.dev/api/icon/bera' },
            'SIGN': { name: '사인', logo: 'https://cryptoicon-api.pages.dev/api/icon/sign' },
            'VANA': { name: '바나', logo: 'https://cryptoicon-api.pages.dev/api/icon/vana' },
            'DOT': { name: '폴카닷', logo: 'https://cryptoicon-api.pages.dev/api/icon/dot' },
            'MET2': { name: '메테오라', logo: 'https://cryptoicon-api.pages.dev/api/icon/met2' },
            'MBL': { name: '무비블록', logo: 'https://cryptoicon-api.pages.dev/api/icon/mbl' },
            'FLUID': { name: '플루이드', logo: 'https://cryptoicon-api.pages.dev/api/icon/fluid' },
            'BIGTIME': { name: '빅타임', logo: 'https://cryptoicon-api.pages.dev/api/icon/bigtime' },
            'SNT': { name: '스테이터스네트워크토큰', logo: 'https://cryptoicon-api.pages.dev/api/icon/snt' },
            'SOL': { name: '솔라나', logo: 'https://cryptoicon-api.pages.dev/api/icon/sol' },
            'QKC': { name: '쿼크체인', logo: 'https://cryptoicon-api.pages.dev/api/icon/qkc' },
            'META': { name: '메타디움', logo: 'https://cryptoicon-api.pages.dev/api/icon/meta' },
            'SAHARA': { name: '사하라에이아이', logo: 'https://cryptoicon-api.pages.dev/api/icon/sahara' },
            'MLK': { name: '밀크', logo: 'https://cryptoicon-api.pages.dev/api/icon/mlk' },
            'SXP': { name: '솔라', logo: 'https://cryptoicon-api.pages.dev/api/icon/sxp' },
            'VTHO': { name: '비토르토큰', logo: 'https://cryptoicon-api.pages.dev/api/icon/vtho' },
            'KITE': { name: '카이트', logo: 'https://cryptoicon-api.pages.dev/api/icon/kite' },
            'MINA': { name: '미나', logo: 'https://cryptoicon-api.pages.dev/api/icon/mina' },
            'MMT': { name: '모멘텀', logo: 'https://cryptoicon-api.pages.dev/api/icon/mmt' },
            'ZORA': { name: '조라', logo: 'https://cryptoicon-api.pages.dev/api/icon/zora' },
            'GAS': { name: '가스', logo: 'https://cryptoicon-api.pages.dev/api/icon/gas' },
            'MNT': { name: '맨틀', logo: 'https://cryptoicon-api.pages.dev/api/icon/mnt' },
            'MOC': { name: '모스코인', logo: 'https://cryptoicon-api.pages.dev/api/icon/moc' },
            'MOODENG': { name: '무뎅', logo: 'https://cryptoicon-api.pages.dev/api/icon/moodeng' },
            'XEC': { name: '이캐시', logo: 'https://cryptoicon-api.pages.dev/api/icon/xec' },
            'MON': { name: '모나드', logo: 'https://cryptoicon-api.pages.dev/api/icon/mon' },
            'ZIL': { name: '질리카', logo: 'https://cryptoicon-api.pages.dev/api/icon/zil' },
            'GAME2': { name: '게임빌드', logo: 'https://cryptoicon-api.pages.dev/api/icon/game2' },
            'STX': { name: '스택스', logo: 'https://cryptoicon-api.pages.dev/api/icon/stx' },
            'FLOCK': { name: '플록', logo: 'https://cryptoicon-api.pages.dev/api/icon/flock' },
            'PROVE': { name: '서싱트', logo: 'https://cryptoicon-api.pages.dev/api/icon/prove' },
            'BSV': { name: '비트코인에스브이', logo: 'https://cryptoicon-api.pages.dev/api/icon/bsv' },
            'SUI': { name: '수이', logo: 'https://cryptoicon-api.pages.dev/api/icon/sui' },
            'SYRUP': { name: '메이플파이낸스', logo: 'https://cryptoicon-api.pages.dev/api/icon/syrup' },
            'BTC': { name: '비트코인', logo: 'https://cryptoicon-api.pages.dev/api/icon/btc' },
            'HOLO': { name: '홀로월드에이아이', logo: 'https://cryptoicon-api.pages.dev/api/icon/holo' },
            'MIRA': { name: '미라네트워크', logo: 'https://cryptoicon-api.pages.dev/api/icon/mira' },
            'SUN': { name: '썬', logo: 'https://cryptoicon-api.pages.dev/api/icon/sun' },
            'ZBT': { name: '제로베이스', logo: 'https://cryptoicon-api.pages.dev/api/icon/zbt' },
            'ONG': { name: '온톨로지가스', logo: 'https://cryptoicon-api.pages.dev/api/icon/ong' },
            'BTT': { name: '비트토렌트', logo: 'https://cryptoicon-api.pages.dev/api/icon/btt' },
            'ENSO': { name: '엔소', logo: 'https://cryptoicon-api.pages.dev/api/icon/enso' },
            'ONT': { name: '온톨로지', logo: 'https://cryptoicon-api.pages.dev/api/icon/ont' },
            'SOMI': { name: '솜니아', logo: 'https://cryptoicon-api.pages.dev/api/icon/somi' },
            'DEEP': { name: '딥북', logo: 'https://cryptoicon-api.pages.dev/api/icon/deep' },
            'STRAX': { name: '저트라', logo: 'https://cryptoicon-api.pages.dev/api/icon/strax' },
            'ICX': { name: '아이콘', logo: 'https://cryptoicon-api.pages.dev/api/icon/icx' },
            'POLYX': { name: '폴리매쉬', logo: 'https://cryptoicon-api.pages.dev/api/icon/polyx' }
        };

        // Get coin info with fallback
        function getCoinInfo(coin) {
            const upperCoin = coin.toUpperCase();
            if (COIN_INFO[upperCoin]) {
                return COIN_INFO[upperCoin];
            }
            // Fallback: use first letter as placeholder
            return {
                name: coin,
                logo: `https://cryptoicon-api.pages.dev/api/icon/${coin.toLowerCase()}`
            };
        }

        // Format price with 2 decimal places
        function formatPrice(price) {
            if (price === null || price === undefined) return '-';
            return Number(price).toLocaleString('ko-KR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // State
        let currentPage = 1;
        let perPage = 50;
        let filters = {};

        // Initialize function
        function init() {
            console.log('[SurgeHistory] Initializing...');

            // Check admin auth - try localStorage first, then parent window (for iframe)
            let token = localStorage.getItem('access_token');

            // If in iframe and no token found, try parent window's localStorage
            if (!token && window.parent && window.parent !== window) {
                try {
                    console.log('[SurgeHistory] Checking parent window localStorage...');
                    token = window.parent.localStorage.getItem('access_token');
                    // Store in current window's localStorage for future use
                    if (token) {
                        localStorage.setItem('access_token', token);
                        console.log('[SurgeHistory] Token copied from parent window');
                    }
                } catch (e) {
                    console.warn('[SurgeHistory] Cannot access parent localStorage:', e.message);
                }
            }

            if (!token) {
                console.error('[SurgeHistory] No access token found in localStorage or parent window');
                alert('로그인이 필요합니다.');
                // If in iframe, redirect parent window instead of iframe
                if (window.parent && window.parent !== window) {
                    window.parent.location.href = '/login.html';
                } else {
                    window.location.href = '/login.html';
                }
                return;
            }
            console.log('[SurgeHistory] Token found, loading data...');

            // Load initial data
            loadMarkets();
            loadData();
        }

        // Initialize when DOM is ready
        // When loaded in iframe, document.readyState starts as 'loading'
        // When loaded directly, it may already be 'interactive' or 'complete'
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            // DOM already loaded, initialize immediately
            // Small delay to ensure all elements are rendered
            setTimeout(init, 50);
        }

        // Load available markets
        async function loadMarkets() {
            console.log('[SurgeHistory] Loading markets...');
            try {
                const url = `${window.location.origin}/api/admin/surge-history/markets`;
                console.log('[SurgeHistory] Fetching markets:', url);

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('[SurgeHistory] Markets response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[SurgeHistory] Markets error:', errorText);
                    throw new Error('Failed to load markets');
                }

                const data = await response.json();
                console.log('[SurgeHistory] Markets loaded:', data.markets.length, 'markets');

                const marketSelect = document.getElementById('filter-market');
                if (!marketSelect) {
                    console.error('[SurgeHistory] filter-market element not found');
                    return;
                }

                data.markets.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m.market;
                    option.textContent = `${m.market} (${m.count})`;
                    marketSelect.appendChild(option);
                });
            } catch (error) {
                console.error('[SurgeHistory] Failed to load markets:', error);
            }
        }

        // Load data
        async function loadData() {
            console.log('[SurgeHistory] Loading data...');
            try {
                const params = new URLSearchParams({
                    page: currentPage,
                    per_page: perPage,
                    ...filters
                });

                const url = `${window.location.origin}/api/admin/surge-history?${params}`;
                console.log('[SurgeHistory] Fetching:', url);

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('[SurgeHistory] Response status:', response.status);

                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        alert('관리자 권한이 필요합니다.');
                        window.location.href = '/dashboard.html';
                        return;
                    }
                    const errorText = await response.text();
                    console.error('[SurgeHistory] Error response:', errorText);
                    throw new Error(`Failed to load data: ${response.status}`);
                }

                const data = await response.json();
                console.log('[SurgeHistory] Data loaded:', data);

                // Update stats
                updateStats(data.stats);

                // Update table
                updateTable(data.data);

                // Update pagination
                updatePagination(data.pagination);

                console.log('[SurgeHistory] UI updated successfully');

            } catch (error) {
                console.error('[SurgeHistory] Failed to load data:', error);
                showError('데이터를 불러오는데 실패했습니다: ' + error.message);
            }
        }

        // Update stats
        function updateStats(stats) {
            const statTotal = document.getElementById('stat-total');
            const statAutoTraded = document.getElementById('stat-auto-traded');
            const statConfidence = document.getElementById('stat-confidence');
            const profitEl = document.getElementById('stat-profit');
            const statProfitable = document.getElementById('stat-profitable');
            const statLosing = document.getElementById('stat-losing');

            if (!statTotal || !statAutoTraded || !statConfidence || !profitEl || !statProfitable || !statLosing) {
                console.error('[SurgeHistory] Stats elements not found');
                return;
            }

            statTotal.textContent = stats.total_alerts.toLocaleString();
            statAutoTraded.textContent = stats.auto_traded_count.toLocaleString();
            statConfidence.textContent = stats.avg_confidence.toFixed(1);

            const profit = stats.total_profit_loss;
            profitEl.textContent = formatPrice(Math.abs(profit));
            profitEl.style.color = profit >= 0 ? '#10b981' : '#ef4444';

            statProfitable.textContent = stats.profitable_trades.toLocaleString();
            statLosing.textContent = stats.losing_trades.toLocaleString();
        }

        // Update table
        function updateTable(data) {
            const tableContent = document.getElementById('table-content');

            if (!tableContent) {
                console.error('[SurgeHistory] table-content element not found');
                return;
            }

            if (data.length === 0) {
                tableContent.innerHTML = `
                    <div class="error-state">
                        <h3>데이터가 없습니다</h3>
                        <p>필터 조건을 변경해보세요.</p>
                    </div>
                `;
                return;
            }

            // Remove duplicates: Keep only first alert for each market+date combination
            const uniqueAlerts = [];
            const seenKeys = new Set();

            data.forEach(alert => {
                const dateKey = alert.sent_at.split('T')[0]; // Extract YYYY-MM-DD
                const key = `${alert.market}_${dateKey}`;

                if (!seenKeys.has(key)) {
                    seenKeys.add(key);
                    uniqueAlerts.push(alert);
                }
            });

            console.log(`[SurgeHistory] Filtered ${data.length} alerts to ${uniqueAlerts.length} unique alerts (removed ${data.length - uniqueAlerts.length} duplicates)`);

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>마켓</th>
                            <th>신뢰도</th>
                            <th>자동거래</th>
                            <th>진입가</th>
                            <th>목표가</th>
                            <th>종료가</th>
                            <th>손절가</th>
                            <th>상태</th>
                            <th>손익</th>
                            <th>발송시간</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            uniqueAlerts.forEach(alert => {
                const confidence = alert.confidence.toFixed(1);
                const profitLoss = alert.profit_loss || 0;
                const profitLossPercent = alert.profit_loss_percent ? alert.profit_loss_percent.toFixed(2) : '0.00';

                // Get coin info
                const coinInfo = getCoinInfo(alert.coin);

                // Status badge color and text
                let statusBadge = 'badge-secondary';
                let statusText = '알 수 없음';
                let statusIcon = '❓';

                if (alert.status === 'win') {
                    statusBadge = 'badge-success';
                    statusText = '수익';
                    statusIcon = '✅';
                } else if (alert.status === 'lose') {
                    statusBadge = 'badge-danger';
                    statusText = '손실';
                    statusIcon = '❌';
                } else if (alert.status === 'pending') {
                    statusBadge = 'badge-info';
                    statusText = '진행중';
                    statusIcon = '⏳';
                } else if (alert.status === 'closed') {
                    statusBadge = profitLoss >= 0 ? 'badge-success' : 'badge-danger';
                    statusText = profitLoss >= 0 ? '종료(수익)' : '종료(손실)';
                    statusIcon = profitLoss >= 0 ? '✅' : '❌';
                } else if (alert.status === 'expired') {
                    statusBadge = profitLoss >= 0 ? 'badge-success' : 'badge-danger';
                    statusText = profitLoss >= 0 ? '만료(수익)' : '만료(손실)';
                    statusIcon = profitLoss >= 0 ? '✅' : '❌';
                } else if (alert.status === 'neutral') {
                    statusBadge = 'badge-secondary';
                    statusText = '중립';
                    statusIcon = '⚪';
                } else if (alert.status === 'backtest') {
                    statusBadge = 'badge-warning';
                    statusText = '백테스트';
                    statusIcon = '📊';
                }

                // Auto-traded badge
                const autoTradedBadge = alert.auto_traded
                    ? '<span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">✅ 거래 시도</span>'
                    : '<span style="background: #e5e7eb; color: #6b7280; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">❌ 수동</span>';

                html += `
                    <tr onclick="viewDetail(${alert.id})" style="cursor: pointer;">
                        <td>${alert.id}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <img src="${coinInfo.logo}" alt="${alert.coin}"
                                     style="width: 24px; height: 24px; border-radius: 50%;"
                                     onerror="this.style.display='none'">
                                <div>
                                    <strong>${coinInfo.name}</strong>
                                    <div style="font-size: 0.85em; color: #666;">${alert.market}</div>
                                </div>
                            </div>
                        </td>
                        <td>${confidence}%</td>
                        <td>${autoTradedBadge}</td>
                        <td>${alert.entry_price ? formatPrice(alert.entry_price) + '원' : '-'}</td>
                        <td style="color: #10b981; font-weight: 600;">${alert.target_price ? formatPrice(alert.target_price) + '원' : '-'}</td>
                        <td style="color: #3b82f6; font-weight: 600;">${alert.exit_price ? formatPrice(alert.exit_price) + '원' : '-'}</td>
                        <td style="color: #ef4444; font-weight: 600;">${alert.stop_loss_price ? formatPrice(alert.stop_loss_price) + '원' : '-'}</td>
                        <td>
                            <span class="badge ${statusBadge}">
                                ${statusIcon} ${statusText}
                            </span>
                        </td>
                        <td style="color: ${profitLoss > 0 ? '#10b981' : profitLoss < 0 ? '#ef4444' : '#666'}; font-weight: 600;">
                            ${profitLoss > 0 ? '+' : ''}${formatPrice(profitLoss)}원
                            <span style="font-size: 0.9em;">(${profitLoss > 0 ? '+' : ''}${profitLossPercent}%)</span>
                            ${alert.close_reason ? '<br><span style="font-size: 0.85em; color: #888;">' + alert.close_reason + '</span>' : ''}
                        </td>
                        <td>${new Date(alert.sent_at).toLocaleString('ko-KR')}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            tableContent.innerHTML = html;
        }

        // Update pagination
        function updatePagination(pagination) {
            const paginationEl = document.getElementById('pagination');

            if (!paginationEl) {
                console.error('[SurgeHistory] pagination element not found');
                return;
            }

            let html = '';

            // Previous button
            html += `<button class="page-btn" ${pagination.page === 1 ? 'disabled' : ''} onclick="goToPage(${pagination.page - 1})">이전</button>`;

            // Page numbers
            const startPage = Math.max(1, pagination.page - 2);
            const endPage = Math.min(pagination.total_pages, pagination.page + 2);

            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="page-btn ${i === pagination.page ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }

            // Next button
            html += `<button class="page-btn" ${pagination.page === pagination.total_pages ? 'disabled' : ''} onclick="goToPage(${pagination.page + 1})">다음</button>`;

            paginationEl.innerHTML = html;
        }

        // Show error
        function showError(message) {
            const tableContent = document.getElementById('table-content');
            if (!tableContent) {
                console.error('[SurgeHistory] table-content element not found, cannot show error');
                return;
            }
            tableContent.innerHTML = `
                <div class="error-state">
                    <h3>오류 발생</h3>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="loadData()">다시 시도</button>
                </div>
            `;
        }

        // Apply filters
        function applyFilters() {
            filters = {};

            const marketEl = document.getElementById('filter-market');
            const signalTypeEl = document.getElementById('filter-signal-type');
            const autoTradedEl = document.getElementById('filter-auto-traded');
            const statusEl = document.getElementById('filter-status');
            const startDateEl = document.getElementById('filter-start-date');
            const endDateEl = document.getElementById('filter-end-date');

            if (!marketEl || !signalTypeEl || !autoTradedEl || !statusEl || !startDateEl || !endDateEl) {
                console.error('[SurgeHistory] Filter elements not found');
                return;
            }

            const market = marketEl.value;
            const signalType = signalTypeEl.value;
            const autoTraded = autoTradedEl.value;
            const status = statusEl.value;
            const startDate = startDateEl.value;
            const endDate = endDateEl.value;

            if (market) filters.market = market;
            if (signalType) filters.signal_type = signalType;
            if (autoTraded) filters.auto_traded = autoTraded;
            if (status) filters.status = status;
            if (startDate) filters.start_date = startDate;
            if (endDate) filters.end_date = endDate;

            currentPage = 1;
            loadData();
        }

        // Reset filters
        function resetFilters() {
            const marketEl = document.getElementById('filter-market');
            const signalTypeEl = document.getElementById('filter-signal-type');
            const autoTradedEl = document.getElementById('filter-auto-traded');
            const statusEl = document.getElementById('filter-status');
            const startDateEl = document.getElementById('filter-start-date');
            const endDateEl = document.getElementById('filter-end-date');

            if (!marketEl || !signalTypeEl || !autoTradedEl || !statusEl || !startDateEl || !endDateEl) {
                console.error('[SurgeHistory] Filter elements not found');
                return;
            }

            marketEl.value = '';
            signalTypeEl.value = '';
            autoTradedEl.value = '';
            statusEl.value = '';
            startDateEl.value = '';
            endDateEl.value = '';

            filters = {};
            currentPage = 1;
            loadData();
        }

        // Change per page
        function changePerPage() {
            const perPageEl = document.getElementById('per-page');
            if (!perPageEl) {
                console.error('[SurgeHistory] per-page element not found');
                return;
            }
            perPage = parseInt(perPageEl.value);
            currentPage = 1;
            loadData();
        }

        // Go to page
        function goToPage(page) {
            currentPage = page;
            loadData();
        }

        // View detail
        function viewDetail(alertId) {
            // TODO: Implement detail modal
            console.log('View detail for alert:', alertId);
        }

        // Export CSV
        async function exportCSV() {
            try {
                const params = new URLSearchParams(filters);

                const response = await fetch(`${window.location.origin}/api/admin/surge-history/export?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });

                if (!response.ok) throw new Error('Failed to export CSV');

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `surge_history_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                alert('CSV 파일이 다운로드되었습니다.');
            } catch (error) {
                console.error('Failed to export CSV:', error);
                alert('CSV 내보내기에 실패했습니다.');
            }
        }

        // Expose functions to global scope for onclick handlers
        window.goToPage = goToPage;
        window.changePerPage = changePerPage;
        window.applyFilters = applyFilters;
        window.resetFilters = resetFilters;
        window.viewDetail = viewDetail;
        window.exportCSV = exportCSV;

    })();
    </script>
</body>
</html>
