<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸‰ë“± ì‹œìŠ¤í…œ ì„¤ì • - CoinPulse Admin</title>
    <link rel="stylesheet" href="css/internal-pages.css">
    <style>
        body {
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }

        .status-badge.active {
            background: #dcfce7;
            color: #16a34a;
        }

        .status-badge.inactive {
            background: #fee2e2;
            color: #dc2626;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 14px;
            color: #6b7280;
        }

        .param-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .param-row:last-child {
            border-bottom: none;
        }

        .param-label {
            font-weight: 600;
            color: #374151;
        }

        .param-value {
            color: #667eea;
            font-weight: 600;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-icon {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .input-unit {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-unit input {
            flex: 1;
        }

        .input-unit span {
            color: #6b7280;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- Header -->
        <div class="page-header flex-between">
            <div>
                <h1>âš™ï¸ ê¸‰ë“± ì‹œìŠ¤í…œ ì„¤ì •</h1>
                <p>ê¸‰ë“± ê°ì§€ ì‹œìŠ¤í…œì˜ ì „ì—­ ì„¤ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
            </div>
            <div>
                <button class="btn btn-secondary" onclick="window.location.href='admin.html'">
                    â† ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ
                </button>
            </div>
        </div>

        <div id="alertContainer"></div>

        <!-- System Status -->
        <div class="card">
            <h2>ğŸ“Š ì‹œìŠ¤í…œ ìƒíƒœ</h2>
            <div class="settings-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                <div class="stat-card">
                    <div class="stat-label">Worker ìƒíƒœ</div>
                    <div id="worker-status" class="stat-value">-</div>
                    <span id="worker-badge" class="status-badge">
                        <span class="status-indicator"></span>
                        í™•ì¸ ì¤‘
                    </span>
                </div>
                <div class="stat-card">
                    <div class="stat-label">í™œì„± ì‹ í˜¸</div>
                    <div id="active-signals" class="stat-value">-</div>
                    <small class="stat-label">pending ìƒíƒœ</small>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ëª¨ë‹ˆí„°ë§ ì½”ì¸</div>
                    <div id="monitored-coins" class="stat-value">-</div>
                    <small class="stat-label">ìºì‹œì—ì„œ ì¶”ì  ì¤‘</small>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ë§ˆì§€ë§‰ ìŠ¤ìº”</div>
                    <div id="last-scan" class="stat-value" style="font-size: 16px;">-</div>
                    <small class="stat-label">ìµœê·¼ ì‹ í˜¸ ë°œì†¡ ì‹œê°„</small>
                </div>
            </div>
        </div>

        <div class="settings-grid">
            <!-- Signal Detection Threshold -->
            <div class="card">
                <h2>ğŸ¯ ì‹ í˜¸ ê°ì§€ ê¸°ì¤€</h2>
                <div class="form-group">
                    <label for="base-min-score">ì‹œìŠ¤í…œ ìµœì†Œ ì ìˆ˜</label>
                    <div class="input-unit">
                        <input type="number" id="base-min-score" value="60" min="50" max="90" step="5">
                        <span>ì </span>
                    </div>
                    <small>Workerê°€ ìŠ¤ìº”í•  ìµœì†Œ ì ìˆ˜ (ì‚¬ìš©ìë³„ í•„í„°ë§ ì´ì „)</small>
                </div>

                <div class="form-group">
                    <label for="telegram-min-score">í…”ë ˆê·¸ë¨ ì•Œë¦¼ ì ìˆ˜</label>
                    <div class="input-unit">
                        <input type="number" id="telegram-min-score" value="70" min="60" max="90" step="5">
                        <span>ì </span>
                    </div>
                    <small>ê³ í’ˆì§ˆ ì‹ í˜¸ë§Œ í…”ë ˆê·¸ë¨ ì•Œë¦¼ ë°œì†¡</small>
                </div>

                <div class="form-group">
                    <label for="db-save-threshold">DB ì €ì¥ ê¸°ì¤€</label>
                    <div class="input-unit">
                        <input type="number" id="db-save-threshold" value="60" min="50" max="90" step="5">
                        <span>ì </span>
                    </div>
                    <small>ì´ ì ìˆ˜ ì´ìƒë§Œ surge_alerts í…Œì´ë¸”ì— ì €ì¥</small>
                </div>
            </div>

            <!-- Worker Configuration -->
            <div class="card">
                <h2>âš¡ Worker ì„¤ì •</h2>
                <div class="form-group">
                    <label for="check-interval">ì²´í¬ ì£¼ê¸°</label>
                    <div class="input-unit">
                        <input type="number" id="check-interval" value="300" min="60" max="600" step="60">
                        <span>ì´ˆ ({{ Math.floor(checkInterval / 60) }}ë¶„)</span>
                    </div>
                    <small>ê¸‰ë“± í›„ë³´ ìŠ¤ìº” ì£¼ê¸° (ê¶Œì¥: 300ì´ˆ = 5ë¶„)</small>
                </div>

                <div class="form-group">
                    <label for="monitor-coins-count">ëª¨ë‹ˆí„°ë§ ì½”ì¸ ìˆ˜</label>
                    <div class="input-unit">
                        <input type="number" id="monitor-coins-count" value="50" min="20" max="100" step="10">
                        <span>ê°œ</span>
                    </div>
                    <small>ê±°ë˜ëŸ‰ ê¸°ì¤€ ìƒìœ„ Nê°œ ì½”ì¸ ëª¨ë‹ˆí„°ë§</small>
                </div>

                <div class="form-group">
                    <label for="duplicate-alert-hours">ì¤‘ë³µ ì•Œë¦¼ ë°©ì§€</label>
                    <div class="input-unit">
                        <input type="number" id="duplicate-alert-hours" value="24" min="1" max="72" step="1">
                        <span>ì‹œê°„</span>
                    </div>
                    <small>ê°™ì€ ì½”ì¸ì— ëŒ€í•œ ì¤‘ë³µ ì•Œë¦¼ ë°©ì§€ ê¸°ê°„</small>
                </div>
            </div>
        </div>

        <!-- Analysis Parameters -->
        <div class="card">
            <h2>ğŸ”¬ ë¶„ì„ íŒŒë¼ë¯¸í„°</h2>
            <p style="color: #6b7280; margin-bottom: 20px;">
                SurgePredictorì˜ ë¶„ì„ ì•Œê³ ë¦¬ì¦˜ íŒŒë¼ë¯¸í„° (ì‹ ì¤‘íˆ ì¡°ì •í•˜ì„¸ìš”)
            </p>
            <div class="settings-grid">
                <div class="form-group">
                    <label for="volume-threshold">ê±°ë˜ëŸ‰ ì¦ê°€ ì„ê³„ê°’</label>
                    <div class="input-unit">
                        <input type="number" id="volume-threshold" value="1.5" min="1.0" max="3.0" step="0.1">
                        <span>ë°°</span>
                    </div>
                    <small>í‰ê·  ëŒ€ë¹„ ê±°ë˜ëŸ‰ ì¦ê°€ ë°°ìˆ˜</small>
                </div>

                <div class="form-group">
                    <label for="rsi-oversold">RSI ê³¼ë§¤ë„ ë ˆë²¨</label>
                    <div class="input-unit">
                        <input type="number" id="rsi-oversold" value="35" min="20" max="40" step="5">
                        <span>RSI</span>
                    </div>
                    <small>RSIê°€ ì´ ê°’ ì´í•˜ë©´ ê³¼ë§¤ë„ë¡œ íŒë‹¨</small>
                </div>

                <div class="form-group">
                    <label for="rsi-buy-zone">RSI ë§¤ìˆ˜ êµ¬ê°„ ìµœëŒ€ê°’</label>
                    <div class="input-unit">
                        <input type="number" id="rsi-buy-zone" value="50" min="40" max="60" step="5">
                        <span>RSI</span>
                    </div>
                    <small>ë§¤ìˆ˜ ì‹ í˜¸ë¡œ ì¸ì •í•  RSI ìƒí•œì„ </small>
                </div>

                <div class="form-group">
                    <label for="support-proximity">ì§€ì§€ì„  ê·¼ì ‘ë„</label>
                    <div class="input-unit">
                        <input type="number" id="support-proximity" value="0.02" min="0.01" max="0.05" step="0.01">
                        <span>ë¹„ìœ¨</span>
                    </div>
                    <small>ì§€ì§€ì„  ê·¼ì²˜ë¡œ íŒë‹¨í•  ê±°ë¦¬ (2% = 0.02)</small>
                </div>

                <div class="form-group">
                    <label for="uptrend-days">ìƒìŠ¹ ì¶”ì„¸ í™•ì¸ ì¼ìˆ˜</label>
                    <div class="input-unit">
                        <input type="number" id="uptrend-days" value="3" min="2" max="7" step="1">
                        <span>ì¼</span>
                    </div>
                    <small>ìƒìŠ¹ ì¶”ì„¸ë¡œ ì¸ì •í•  ìµœì†Œ ì¼ìˆ˜</small>
                </div>

                <div class="form-group">
                    <label for="min-surge-score">ìµœì†Œ ê¸‰ë“± í™•ë¥  ì ìˆ˜</label>
                    <div class="input-unit">
                        <input type="number" id="min-surge-score" value="60" min="50" max="80" step="5">
                        <span>ì </span>
                    </div>
                    <small>ë¶„ì„ ì•Œê³ ë¦¬ì¦˜ì˜ ê¸°ë³¸ ì„ê³„ê°’</small>
                </div>
            </div>
        </div>

        <!-- Current Settings Display -->
        <div class="card">
            <h2>ğŸ“‹ í˜„ì¬ ì ìš© ì¤‘ì¸ ì„¤ì •</h2>
            <div id="current-settings">
                <p style="color: #6b7280;">ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="card">
            <div class="btn-group">
                <button class="btn btn-primary" onclick="saveSettings()">
                    <span class="btn-icon">ğŸ’¾ ì„¤ì • ì €ì¥</span>
                </button>
                <button class="btn btn-secondary" onclick="loadSettings()">
                    <span class="btn-icon">ğŸ”„ ì„¤ì • ìƒˆë¡œê³ ì¹¨</span>
                </button>
                <button class="btn btn-secondary" onclick="resetToDefaults()">
                    <span class="btn-icon">â†©ï¸ ê¸°ë³¸ê°’ ë³µì›</span>
                </button>
            </div>
            <p style="color: #ef4444; margin-top: 15px; font-size: 14px;">
                âš ï¸ ì„¤ì • ë³€ê²½ í›„ ì„œë²„ë¥¼ ì¬ì‹œì‘í•´ì•¼ ì ìš©ë©ë‹ˆë‹¤.
            </p>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        function getAuthToken() {
            return localStorage.getItem('authToken');
        }

        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.marginBottom = '20px';
            container.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        async function loadStatus() {
            const token = getAuthToken();
            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/admin/surge/status`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    const status = data.status;

                    // Update status display
                    document.getElementById('worker-status').textContent =
                        status.worker_running ? 'ì‹¤í–‰ ì¤‘' : 'ì¤‘ì§€ë¨';

                    const workerBadge = document.getElementById('worker-badge');
                    workerBadge.className = `status-badge ${status.worker_running ? 'active' : 'inactive'}`;
                    workerBadge.innerHTML = `
                        <span class="status-indicator"></span>
                        ${status.worker_running ? 'ì‹¤í–‰ ì¤‘' : 'ì¤‘ì§€ë¨'}
                    `;

                    document.getElementById('active-signals').textContent = status.active_signals;
                    document.getElementById('monitored-coins').textContent = status.monitored_coins;

                    if (status.last_scan) {
                        const date = new Date(status.last_scan);
                        document.getElementById('last-scan').textContent =
                            date.toLocaleString('ko-KR', {
                                month: 'short',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                    }
                }
            } catch (error) {
                console.error('Load status error:', error);
            }
        }

        async function loadSettings() {
            const token = getAuthToken();
            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/admin/surge/settings`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success && data.settings) {
                    const s = data.settings;
                    const config = s.analysis_config || {};

                    // Signal detection
                    document.getElementById('base-min-score').value = s.base_min_score;
                    document.getElementById('telegram-min-score').value = s.telegram_min_score;
                    document.getElementById('db-save-threshold').value = s.db_save_threshold;

                    // Worker settings
                    document.getElementById('check-interval').value = s.check_interval;
                    document.getElementById('monitor-coins-count').value = s.monitor_coins_count;
                    document.getElementById('duplicate-alert-hours').value = s.duplicate_alert_hours;

                    // Analysis parameters
                    document.getElementById('volume-threshold').value =
                        config.volume_increase_threshold || 1.5;
                    document.getElementById('rsi-oversold').value =
                        config.rsi_oversold_level || 35;
                    document.getElementById('rsi-buy-zone').value =
                        config.rsi_buy_zone_max || 50;
                    document.getElementById('support-proximity').value =
                        config.support_level_proximity || 0.02;
                    document.getElementById('uptrend-days').value =
                        config.uptrend_confirmation_days || 3;
                    document.getElementById('min-surge-score').value =
                        config.min_surge_probability_score || 60;

                    // Display current settings
                    displayCurrentSettings(s);

                    showAlert('ì„¤ì •ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤', 'success');
                }
            } catch (error) {
                console.error('Load settings error:', error);
                showAlert('ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        function displayCurrentSettings(settings) {
            const container = document.getElementById('current-settings');
            const config = settings.analysis_config || {};

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                    <div>
                        <h3 style="margin-bottom: 10px; color: #374151;">ì‹ í˜¸ ê°ì§€ ê¸°ì¤€</h3>
                        <div class="param-row">
                            <span class="param-label">ì‹œìŠ¤í…œ ìµœì†Œ ì ìˆ˜</span>
                            <span class="param-value">${settings.base_min_score}ì </span>
                        </div>
                        <div class="param-row">
                            <span class="param-label">í…”ë ˆê·¸ë¨ ì•Œë¦¼ ì ìˆ˜</span>
                            <span class="param-value">${settings.telegram_min_score}ì </span>
                        </div>
                        <div class="param-row">
                            <span class="param-label">DB ì €ì¥ ê¸°ì¤€</span>
                            <span class="param-value">${settings.db_save_threshold}ì </span>
                        </div>
                    </div>
                    <div>
                        <h3 style="margin-bottom: 10px; color: #374151;">Worker ì„¤ì •</h3>
                        <div class="param-row">
                            <span class="param-label">ì²´í¬ ì£¼ê¸°</span>
                            <span class="param-value">${settings.check_interval}ì´ˆ (${Math.floor(settings.check_interval/60)}ë¶„)</span>
                        </div>
                        <div class="param-row">
                            <span class="param-label">ëª¨ë‹ˆí„°ë§ ì½”ì¸</span>
                            <span class="param-value">${settings.monitor_coins_count}ê°œ</span>
                        </div>
                        <div class="param-row">
                            <span class="param-label">ì¤‘ë³µ ë°©ì§€</span>
                            <span class="param-value">${settings.duplicate_alert_hours}ì‹œê°„</span>
                        </div>
                    </div>
                    <div>
                        <h3 style="margin-bottom: 10px; color: #374151;">ë©”íƒ€ ì •ë³´</h3>
                        <div class="param-row">
                            <span class="param-label">ë§ˆì§€ë§‰ ìˆ˜ì •</span>
                            <span class="param-value">${new Date(settings.updated_at).toLocaleString('ko-KR')}</span>
                        </div>
                        <div class="param-row">
                            <span class="param-label">ìˆ˜ì •ì</span>
                            <span class="param-value">${settings.updated_by || '-'}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        async function saveSettings() {
            const token = getAuthToken();
            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            if (!confirm('ì„¤ì •ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì„œë²„ ì¬ì‹œì‘ í›„ ì ìš©ë©ë‹ˆë‹¤.')) {
                return;
            }

            try {
                const settings = {
                    base_min_score: parseInt(document.getElementById('base-min-score').value),
                    telegram_min_score: parseInt(document.getElementById('telegram-min-score').value),
                    db_save_threshold: parseInt(document.getElementById('db-save-threshold').value),
                    check_interval: parseInt(document.getElementById('check-interval').value),
                    monitor_coins_count: parseInt(document.getElementById('monitor-coins-count').value),
                    duplicate_alert_hours: parseInt(document.getElementById('duplicate-alert-hours').value),
                    analysis_config: {
                        volume_increase_threshold: parseFloat(document.getElementById('volume-threshold').value),
                        rsi_oversold_level: parseInt(document.getElementById('rsi-oversold').value),
                        rsi_buy_zone_max: parseInt(document.getElementById('rsi-buy-zone').value),
                        support_level_proximity: parseFloat(document.getElementById('support-proximity').value),
                        uptrend_confirmation_days: parseInt(document.getElementById('uptrend-days').value),
                        min_surge_probability_score: parseInt(document.getElementById('min-surge-score').value)
                    },
                    notes: `Updated via admin panel at ${new Date().toISOString()}`
                };

                const response = await fetch(`${API_BASE}/api/admin/surge/settings`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ì„œë²„ë¥¼ ì¬ì‹œì‘í•˜ì—¬ ì ìš©í•˜ì„¸ìš”.', 'success');
                    await loadSettings();
                } else {
                    throw new Error(data.error || 'ì„¤ì • ì €ì¥ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('Save settings error:', error);
                showAlert('ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        function resetToDefaults() {
            if (!confirm('ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            // Signal detection
            document.getElementById('base-min-score').value = 60;
            document.getElementById('telegram-min-score').value = 70;
            document.getElementById('db-save-threshold').value = 60;

            // Worker settings
            document.getElementById('check-interval').value = 300;
            document.getElementById('monitor-coins-count').value = 50;
            document.getElementById('duplicate-alert-hours').value = 24;

            // Analysis parameters
            document.getElementById('volume-threshold').value = 1.5;
            document.getElementById('rsi-oversold').value = 35;
            document.getElementById('rsi-buy-zone').value = 50;
            document.getElementById('support-proximity').value = 0.02;
            document.getElementById('uptrend-days').value = 3;
            document.getElementById('min-surge-score').value = 60;

            showAlert('ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì ìš©í•˜ì„¸ìš”.', 'info');
        }

        // Initialize
        async function init() {
            const token = getAuthToken();
            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            await loadSettings();
            await loadStatus();

            // Refresh status every 30 seconds
            setInterval(loadStatus, 30000);
        }

        init();
    </script>
</body>
</html>
