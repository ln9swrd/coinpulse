<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>코인펄스 관리자 대시보드 v2.0</title>
    <link rel="stylesheet" href="css/internal-pages.css">
    <style>
        /* Admin-specific overrides and extensions */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
        }

        .admin-info {
            text-align: right;
        }

        .admin-token {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 5px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            overflow-x: auto;
        }

        .tab {
            padding: 16px 32px;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
            white-space: nowrap;
            border: none;
            background: none;
        }

        .tab:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            background: white;
        }

        /* Content Area */
        .content {
            padding: 40px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 16px;
            border: 2px solid #e9ecef;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .stat-label {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #212529;
        }

        .stat-value.highlight {
            color: #667eea;
        }

        /* Search & Actions */
        .actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            gap: 16px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        /* Dropdown Button */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background: white;
            min-width: 150px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            z-index: 1000;
            margin-top: 4px;
        }

        .dropdown-content button {
            display: block;
            width: 100%;
            padding: 10px 16px;
            border: none;
            background: white;
            text-align: left;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }

        .dropdown-content button:hover {
            background: #f8f9fa;
        }

        .dropdown.active .dropdown-content {
            display: block;
        }

        /* Table */
        .table-container {
            background: white;
            border-radius: 16px;
            border: 2px solid #e9ecef;
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8f9fa;
        }

        th {
            padding: 16px;
            text-align: left;
            font-weight: 700;
            color: #495057;
            font-size: 14px;
            border-bottom: 2px solid #e9ecef;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid #f8f9fa;
            color: #212529;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* Inactive user row */
        tr.inactive-user {
            opacity: 0.6;
            background: #f8f9fa;
        }

        tr.inactive-user td {
            color: #6c757d;
            text-decoration: line-through;
        }

        tr.inactive-user:hover {
            background: #e9ecef;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 24px;
        }

        .modal-header h2 {
            font-size: 24px;
            color: #212529;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .empty-state-text {
            font-size: 18px;
            color: #6c757d;
            margin-bottom: 24px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                border-radius: 0;
            }
            
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .content {
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .actions-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                min-width: 100%;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px;
            }

            /* Table horizontal scroll */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                min-width: 800px;
            }

            /* Improve button touch targets */
            .btn {
                padding: 10px 16px;
                font-size: 13px;
                min-height: 44px;
            }

            /* Dropdown button larger touch area */
            .dropdown-toggle {
                min-height: 44px;
                padding: 8px 12px;
            }

            /* Custom scrollbar for table */
            .table-container::-webkit-scrollbar {
                height: 8px;
            }

            .table-container::-webkit-scrollbar-track {
                background: #f1f5f9;
                border-radius: 4px;
            }

            .table-container::-webkit-scrollbar-thumb {
                background: rgba(102, 126, 234, 0.5);
                border-radius: 4px;
            }

            .table-container::-webkit-scrollbar-thumb:hover {
                background: rgba(102, 126, 234, 0.7);
            }
        }

        /* Surge Settings Tab Styles */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }

        .status-badge.active {
            background: #dcfce7;
            color: #16a34a;
        }

        .status-badge.inactive {
            background: #fee2e2;
            color: #dc2626;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse-indicator 2s infinite;
        }

        @keyframes pulse-indicator {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .param-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .param-row:last-child {
            border-bottom: none;
        }

        .param-label {
            font-weight: 600;
            color: #374151;
        }

        .param-value {
            color: #667eea;
            font-weight: 600;
        }

        .input-unit {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-unit input {
            flex: 1;
        }

        .input-unit span {
            color: #6b7280;
            font-size: 14px;
        }
    </style>
    <script src="js/error-handler.js?v=20251227"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div>
                <h1>🎛️ 코인펄스 관리자 대시보드</h1>
                <div class="admin-token" id="tokenDisplay">토큰: 로딩 중...</div>
            </div>
            <div class="admin-info">
                <button class="btn btn-secondary" onclick="logout()">로그아웃</button>
            </div>
        </header>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('stats')">📊 대시보드</button>
            <button class="tab" onclick="switchTab('users')">👥 사용자</button>
            <button class="tab" onclick="switchTab('payments')">💳 결제</button>
            <button class="tab" onclick="switchTab('beta')">🧪 베타 테스터</button>
            <button class="tab" onclick="switchTab('plans')">💎 플랜</button>
            <button class="tab" onclick="switchTab('feedback')">💬 피드백</button>
            <button class="tab" onclick="switchTab('enterprise')">⭐ Enterprise 상담</button>
            <button class="tab" onclick="switchTab('surge-settings')">⚙️ 급등 감지 설정</button>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Stats Tab -->
            <div id="stats-tab" class="tab-content active">
                <div class="stats-grid" id="statsCards">
                    <div class="stat-card">
                        <div class="stat-label">전체 사용자</div>
                        <div class="stat-value highlight" id="statTotalUsers">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">활성 구독</div>
                        <div class="stat-value" id="statActiveSubscriptions">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">대기 중 결제</div>
                        <div class="stat-value" id="statPendingPayments">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">베타 테스터</div>
                        <div class="stat-value" id="statBetaTesters">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">월간 수익</div>
                        <div class="stat-value" id="statMonthlyRevenue">₩0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">총 수익</div>
                        <div class="stat-value" id="statTotalRevenue">₩0</div>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="users-tab" class="tab-content">
                <div class="actions-bar">
                    <div class="search-box">
                        <input type="text" id="userSearch" placeholder="🔍 사용자 검색..." onkeyup="filterUsers()">
                    </div>
                    <select id="userStatusFilter" onchange="loadUsers()" style="padding: 12px 20px; border: 2px solid #e9ecef; border-radius: 12px; font-size: 14px; cursor: pointer;">
                        <option value="active">활성 사용자</option>
                        <option value="inactive">비활성 사용자</option>
                        <option value="all">전체 사용자</option>
                    </select>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>이메일</th>
                                <th>사용자명</th>
                                <th>현재 플랜</th>
                                <th>상태</th>
                                <th>업비트 키</th>
                                <th>만료일</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <tr><td colspan="7" class="loading">로딩 중...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Payments Tab -->
            <div id="payments-tab" class="tab-content">
                <div class="actions-bar">
                    <div class="search-box">
                        <input type="text" id="paymentSearch" placeholder="🔍 결제 검색..." onkeyup="filterPayments()">
                    </div>
                    <select id="paymentStatusFilter" onchange="loadPayments()">
                        <option value="pending">대기 중</option>
                        <option value="approved">승인됨</option>
                        <option value="rejected">거부됨</option>
                        <option value="all">전체</option>
                    </select>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>결제 코드</th>
                                <th>이메일</th>
                                <th>플랜</th>
                                <th>금액</th>
                                <th>상태</th>
                                <th>날짜</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTable">
                            <tr><td colspan="7" class="loading">로딩 중...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Beta Testers Tab -->
            <div id="beta-tab" class="tab-content">
                <div class="actions-bar">
                    <div class="search-box">
                        <input type="text" id="betaSearch" placeholder="🔍 베타 테스터 검색..." onkeyup="filterBeta()">
                    </div>
                    <button class="btn btn-primary" onclick="openAddBetaModal()">+ 베타 테스터 추가</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>이메일</th>
                                <th>이름</th>
                                <th>상태</th>
                                <th>가입일</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody id="betaTable">
                            <tr><td colspan="5" class="loading">로딩 중...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Plans Tab -->
            <div id="plans-tab" class="tab-content">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>플랜</th>
                                <th>가격</th>
                                <th>기능</th>
                                <th>상태</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody id="plansTable">
                            <tr><td colspan="5" class="loading">로딩 중...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Feedback Tab -->
            <div id="feedback-tab" class="tab-content">
                <div class="actions-bar">
                    <div class="search-box">
                        <input type="text" id="feedbackSearch" placeholder="🔍 피드백 검색..." onkeyup="filterFeedback()">
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <select id="feedbackTypeFilter" onchange="loadFeedback()" style="padding: 12px 20px; border: 2px solid #e9ecef; border-radius: 12px; font-size: 14px; cursor: pointer;">
                            <option value="">전체 유형</option>
                            <option value="bug">🐛 버그</option>
                            <option value="feature">💡 기능 제안</option>
                            <option value="general">💭 일반</option>
                        </select>
                        <select id="feedbackStatusFilter" onchange="loadFeedback()" style="padding: 12px 20px; border: 2px solid #e9ecef; border-radius: 12px; font-size: 14px; cursor: pointer;">
                            <option value="">전체 상태</option>
                            <option value="new">🆕 새로운</option>
                            <option value="in_progress">⏳ 진행 중</option>
                            <option value="resolved">✅ 해결됨</option>
                            <option value="closed">🔒 종료됨</option>
                        </select>
                        <select id="feedbackPriorityFilter" onchange="loadFeedback()" style="padding: 12px 20px; border: 2px solid #e9ecef; border-radius: 12px; font-size: 14px; cursor: pointer;">
                            <option value="">전체 우선순위</option>
                            <option value="urgent">🚨 긴급</option>
                            <option value="high">⚠️ 높음</option>
                            <option value="normal">ℹ️ 보통</option>
                            <option value="low">💬 낮음</option>
                        </select>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>유형</th>
                                <th>우선순위</th>
                                <th>제목</th>
                                <th>사용자</th>
                                <th>상태</th>
                                <th>생성일</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody id="feedbackTable">
                            <tr><td colspan="8" class="loading">로딩 중...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Enterprise Inquiries Tab -->
            <div id="enterprise-tab" class="tab-content">
                <div class="actions-bar">
                    <div class="search-box">
                        <input type="text" id="enterpriseSearch" placeholder="🔍 Enterprise 상담 검색..." onkeyup="filterEnterpriseInquiries()">
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <select id="enterpriseStatusFilter" onchange="loadEnterpriseInquiries()" style="padding: 12px 20px; border: 2px solid #e9ecef; border-radius: 12px; font-size: 14px; cursor: pointer;">
                            <option value="">전체 상태</option>
                            <option value="pending">⏳ 대기</option>
                            <option value="contacted">📞 연락완료</option>
                            <option value="converted">✅ 계약완료</option>
                            <option value="rejected">❌ 거절</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadEnterpriseInquiries()">🔄 새로고침</button>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>이름</th>
                                <th>회사</th>
                                <th>이메일</th>
                                <th>전화번호</th>
                                <th>거래량</th>
                                <th>상태</th>
                                <th>신청일</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody id="enterpriseTable">
                            <tr><td colspan="9" class="loading">로딩 중...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Surge Settings Tab -->
    <div id="surge-settings-tab" class="tab-content">
        <div id="surge-alertContainer"></div>

        <!-- System Status -->
        <div class="card">
            <h2>📊 시스템 상태</h2>
            <div class="settings-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                <div class="stat-card">
                    <div class="stat-label">Worker 상태</div>
                    <div id="surge-worker-status" class="stat-value">-</div>
                    <span id="surge-worker-badge" class="status-badge">
                        <span class="status-indicator"></span>
                        확인 중
                    </span>
                </div>
                <div class="stat-card">
                    <div class="stat-label">활성 신호</div>
                    <div id="surge-active-signals" class="stat-value">-</div>
                    <small class="stat-label">pending 상태</small>
                </div>
                <div class="stat-card">
                    <div class="stat-label">모니터링 코인</div>
                    <div id="surge-monitored-coins" class="stat-value">-</div>
                    <small class="stat-label">캐시에서 추적 중</small>
                </div>
                <div class="stat-card">
                    <div class="stat-label">마지막 스캔</div>
                    <div id="surge-last-scan" class="stat-value" style="font-size: 16px;">-</div>
                    <small class="stat-label">최근 신호 발송 시간</small>
                </div>
            </div>
        </div>

        <div class="settings-grid">
            <!-- Signal Detection Threshold -->
            <div class="card">
                <h2>🎯 신호 감지 기준</h2>
                <div class="form-group">
                    <label for="surge-base-min-score">시스템 최소 점수</label>
                    <div class="input-unit">
                        <input type="number" id="surge-base-min-score" value="60" min="50" max="90" step="5">
                        <span>점</span>
                    </div>
                    <small>Worker가 스캔할 최소 점수 (사용자별 필터링 이전)</small>
                </div>

                <div class="form-group">
                    <label for="surge-telegram-min-score">텔레그램 알림 점수</label>
                    <div class="input-unit">
                        <input type="number" id="surge-telegram-min-score" value="70" min="60" max="90" step="5">
                        <span>점</span>
                    </div>
                    <small>고품질 신호만 텔레그램 알림 발송</small>
                </div>

                <div class="form-group">
                    <label for="surge-db-save-threshold">DB 저장 기준</label>
                    <div class="input-unit">
                        <input type="number" id="surge-db-save-threshold" value="60" min="50" max="90" step="5">
                        <span>점</span>
                    </div>
                    <small>이 점수 이상만 surge_alerts 테이블에 저장</small>
                </div>
            </div>

            <!-- Worker Configuration -->
            <div class="card">
                <h2>⚡ Worker 설정</h2>
                <div class="form-group">
                    <label for="surge-check-interval">체크 주기</label>
                    <div class="input-unit">
                        <input type="number" id="surge-check-interval" value="300" min="60" max="600" step="60">
                        <span>초</span>
                    </div>
                    <small>급등 후보 스캔 주기 (권장: 300초 = 5분)</small>
                </div>

                <div class="form-group">
                    <label for="surge-monitor-coins-count">모니터링 코인 수</label>
                    <div class="input-unit">
                        <input type="number" id="surge-monitor-coins-count" value="50" min="20" max="100" step="10">
                        <span>개</span>
                    </div>
                    <small>거래량 기준 상위 N개 코인 모니터링</small>
                </div>

                <div class="form-group">
                    <label for="surge-duplicate-alert-hours">중복 알림 방지</label>
                    <div class="input-unit">
                        <input type="number" id="surge-duplicate-alert-hours" value="24" min="1" max="72" step="1">
                        <span>시간</span>
                    </div>
                    <small>같은 코인에 대한 중복 알림 방지 기간</small>
                </div>
            </div>
        </div>

        <!-- Analysis Parameters -->
        <div class="card">
            <h2>🔬 분석 파라미터</h2>
            <p style="color: #6b7280; margin-bottom: 20px;">
                SurgePredictor의 분석 알고리즘 파라미터 (신중히 조정하세요)
            </p>
            <div class="settings-grid">
                <div class="form-group">
                    <label for="surge-volume-threshold">거래량 증가 임계값</label>
                    <div class="input-unit">
                        <input type="number" id="surge-volume-threshold" value="1.5" min="1.0" max="3.0" step="0.1">
                        <span>배</span>
                    </div>
                    <small>평균 대비 거래량 증가 배수</small>
                </div>

                <div class="form-group">
                    <label for="surge-rsi-oversold">RSI 과매도 레벨</label>
                    <div class="input-unit">
                        <input type="number" id="surge-rsi-oversold" value="35" min="20" max="40" step="5">
                        <span>RSI</span>
                    </div>
                    <small>RSI가 이 값 이하면 과매도로 판단</small>
                </div>

                <div class="form-group">
                    <label for="surge-rsi-buy-zone">RSI 매수 구간 최대값</label>
                    <div class="input-unit">
                        <input type="number" id="surge-rsi-buy-zone" value="50" min="40" max="60" step="5">
                        <span>RSI</span>
                    </div>
                    <small>매수 신호로 인정할 RSI 상한선</small>
                </div>

                <div class="form-group">
                    <label for="surge-support-proximity">지지선 근접도</label>
                    <div class="input-unit">
                        <input type="number" id="surge-support-proximity" value="0.02" min="0.01" max="0.05" step="0.01">
                        <span>비율</span>
                    </div>
                    <small>지지선 근처로 판단할 거리 (2% = 0.02)</small>
                </div>

                <div class="form-group">
                    <label for="surge-uptrend-days">상승 추세 확인 일수</label>
                    <div class="input-unit">
                        <input type="number" id="surge-uptrend-days" value="3" min="2" max="7" step="1">
                        <span>일</span>
                    </div>
                    <small>상승 추세로 인정할 최소 일수</small>
                </div>

                <div class="form-group">
                    <label for="surge-min-surge-score">최소 급등 확률 점수</label>
                    <div class="input-unit">
                        <input type="number" id="surge-min-surge-score" value="60" min="50" max="80" step="5">
                        <span>점</span>
                    </div>
                    <small>분석 알고리즘의 기본 임계값</small>
                </div>
            </div>
        </div>

        <!-- Current Settings Display -->
        <div class="card">
            <h2>📋 현재 적용 중인 설정</h2>
            <div id="surge-current-settings">
                <p style="color: #6b7280;">설정을 불러오는 중...</p>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="card">
            <div class="btn-group">
                <button class="btn btn-primary" onclick="saveSurgeSettings()">
                    <span class="btn-icon">💾 설정 저장</span>
                </button>
                <button class="btn btn-secondary" onclick="loadSurgeSettings()">
                    <span class="btn-icon">🔄 설정 새로고침</span>
                </button>
                <button class="btn btn-secondary" onclick="resetSurgeToDefaults()">
                    <span class="btn-icon">↩️ 기본값 복원</span>
                </button>
            </div>
            <p style="color: #ef4444; margin-top: 15px; font-size: 14px;">
                ⚠️ 설정 변경 후 서버를 재시작해야 적용됩니다.
            </p>
        </div>
    </div>

    <!-- Modals -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>플랜 변경 (수동)</h2>
                <p style="color: #6c757d; font-size: 14px; margin-top: 8px;">계좌이체 확인 후 플랜을 수동으로 변경합니다</p>
            </div>
            <form id="userForm">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label>이메일</label>
                    <input type="email" id="editUserEmail" readonly style="background: #f8f9fa;">
                </div>
                <div class="form-group">
                    <label>플랜 선택 *</label>
                    <select id="editUserPlan" required>
                        <option value="free">무료 (FREE) - ₩0</option>
                        <option value="basic">베이직 (BASIC) - ₩29,000/월</option>
                        <option value="pro">프로 (PRO) - ₩59,000/월</option>
                        <option value="enterprise">엔터프라이즈 (ENTERPRISE) - ₩149,000/월~</option>
                    </select>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                        <span>기간 (일수)</span>
                        <label style="font-weight: normal; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; margin: 0;">
                            <input type="checkbox" id="editUnlimited" onchange="toggleUnlimitedPeriod()" style="cursor: pointer;">
                            <span>♾️ 무제한</span>
                        </label>
                    </label>
                    <input type="number" id="editDurationDays" value="30" min="1" max="99999" required style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px;">
                    <small id="durationHelp" style="display: block; margin-top: 4px; color: #6c757d; font-size: 12px;">플랜 활성 기간 (기본: 30일)</small>
                </div>
                <div class="form-group">
                    <label>관리자 메모</label>
                    <textarea id="editNotes" placeholder="예: 계좌이체 확인 - 홍길동, 49,000원" rows="3"></textarea>
                    <small>입금 확인 내용을 기록해 주세요</small>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('userModal')">취소</button>
                    <button type="submit" class="btn btn-primary">플랜 변경</button>
                </div>
            </form>
        </div>
    </div>

    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>결제 요청 상세</h2>
            </div>
            <div id="paymentDetails"></div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('paymentModal')">닫기</button>
                <button type="button" class="btn btn-success" onclick="approvePayment()">✓ 승인</button>
                <button type="button" class="btn btn-danger" onclick="rejectPayment()">✗ 거부</button>
            </div>
        </div>
    </div>

    <div id="betaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>베타 테스터 추가</h2>
            </div>
            <form id="betaForm">
                <div class="form-group">
                    <label>이메일 *</label>
                    <input type="email" id="betaEmail" required>
                </div>
                <div class="form-group">
                    <label>이름</label>
                    <input type="text" id="betaName">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('betaModal')">취소</button>
                    <button type="submit" class="btn btn-primary">추가</button>
                </div>
            </form>
        </div>
    </div>

    <div id="subscriptionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>구독 상세 관리</h2>
                <p style="color: #6c757d; font-size: 14px; margin-top: 8px;">사용자의 구독 정보를 상세하게 관리합니다</p>
            </div>
            <form id="subscriptionForm">
                <input type="hidden" id="subUserId">
                <div class="form-group">
                    <label>이메일</label>
                    <input type="email" id="subUserEmail" readonly style="background: #f8f9fa;">
                </div>
                <div class="form-group">
                    <label>플랜 *</label>
                    <select id="subPlan" required>
                        <option value="free">무료 (FREE)</option>
                        <option value="basic">베이직 (BASIC)</option>
                        <option value="pro">프로 (PRO)</option>
                        <option value="enterprise">엔터프라이즈 (ENTERPRISE)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>상태 *</label>
                    <select id="subStatus" required>
                        <option value="active">활성 (ACTIVE)</option>
                        <option value="cancelled">취소됨 (CANCELLED)</option>
                        <option value="expired">만료됨 (EXPIRED)</option>
                        <option value="pending">대기 중 (PENDING)</option>
                        <option value="trial">체험판 (TRIAL)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>청구 주기 *</label>
                    <select id="subBillingPeriod" required>
                        <option value="monthly">월간 (MONTHLY)</option>
                        <option value="annual">연간 (ANNUAL)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>시작 날짜 *</label>
                    <input type="datetime-local" id="subStartDate" required>
                    <small>구독 시작 날짜</small>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                        <span>종료 날짜</span>
                        <label style="font-weight: normal; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; margin: 0;">
                            <input type="checkbox" id="subUnlimited" onchange="toggleSubUnlimitedPeriod()" style="cursor: pointer;">
                            <span>♾️ 무제한</span>
                        </label>
                    </label>
                    <input type="datetime-local" id="subEndDate" required>
                    <small id="subEndDateHelp">구독 만료 날짜</small>
                </div>
                <div class="form-group">
                    <label>사유</label>
                    <textarea id="subReason" placeholder="변경 사유를 입력하세요" rows="3"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('subscriptionModal')">취소</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Feedback Detail Modal -->
    <div id="feedbackModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>피드백 상세</h2>
            </div>
            <div id="feedbackDetails" style="padding: 20px;">
                <!-- Feedback details will be loaded here -->
            </div>
            <form id="feedbackForm" style="padding: 0 20px 20px;">
                <input type="hidden" id="feedbackId">
                <div class="form-group">
                    <label>상태 *</label>
                    <select id="feedbackStatus" required>
                        <option value="new">🆕 새로운</option>
                        <option value="in_progress">⏳ 진행 중</option>
                        <option value="resolved">✅ 해결됨</option>
                        <option value="closed">🔒 종료됨</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>관리자 메모</label>
                    <textarea id="feedbackAdminNotes" placeholder="관리자 메모를 입력하세요" rows="4"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('feedbackModal')">취소</button>
                    <button type="button" class="btn btn-danger" onclick="deleteFeedback()" style="margin-right: auto;">삭제</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Enterprise Inquiry Detail Modal -->
    <div id="enterpriseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>⭐ Enterprise 상담 상세</h2>
            </div>
            <div id="enterpriseDetails" style="padding: 20px; background: #f8f9fa; border-radius: 12px; margin: 20px;">
                <!-- Enterprise inquiry details will be loaded here -->
            </div>
            <form id="enterpriseForm" style="padding: 0 20px 20px;">
                <input type="hidden" id="enterpriseId">
                <div class="form-group">
                    <label>상태 *</label>
                    <select id="enterpriseStatus" required style="padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px;">
                        <option value="pending">⏳ 대기</option>
                        <option value="contacted">📞 연락완료</option>
                        <option value="converted">✅ 계약완료</option>
                        <option value="rejected">❌ 거절</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>관리자 메모</label>
                    <textarea id="enterpriseAdminNote" placeholder="고객과의 상담 내용, 견적, 특이사항 등을 기록하세요" rows="6" style="padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px; width: 100%; resize: vertical;"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('enterpriseModal')">취소</button>
                    <button type="submit" class="btn btn-primary">상태 업데이트</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuration - Use admin-specific API base (avoid global API_BASE conflict)
        // Use window object to avoid duplicate declaration on dynamic page reload
        window.ADMIN_API_BASE = window.ADMIN_API_BASE || (window.location.origin + '/api/admin');
        window.adminToken = window.adminToken || localStorage.getItem('access_token') || '';
        window.currentPaymentId = window.currentPaymentId || null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadDashboard();
        });

        // Auth
        function checkAuth() {
            if (!window.adminToken) {
                alert('로그인이 필요합니다. 로그인 페이지로 이동합니다.');
                window.location.href = '/login.html';
                return;
            }

            // Display token info
            document.getElementById('tokenDisplay').textContent = `토큰: ${window.adminToken.substring(0, 20)}...`;

            // Verify admin access
            verifyAdminAccess();
        }

        async function verifyAdminAccess() {
            try {
                const response = await fetch(`${window.location.origin}/api/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${window.adminToken}`
                    }
                });
                const data = await response.json();

                if (!data.success || !data.user.is_admin) {
                    alert('관리자 권한이 없습니다.');
                    window.location.href = '/dashboard.html';
                    return;
                }
            } catch (error) {
                console.error('Admin verification failed:', error);
                alert('권한 확인 중 오류가 발생했습니다.');
                window.location.href = '/dashboard.html';
            }
        }

        function logout() {
            if (confirm('로그아웃 하시겠습니까?')) {
                localStorage.removeItem('access_token');
                window.location.href = '/login.html';
            }
        }

        function getHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${window.adminToken}`
            };
        }

        // Tab Switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Load data
            switch(tabName) {
                case 'stats': loadDashboard(); break;
                case 'users': loadUsers(); break;
                case 'payments': loadPayments(); break;
                case 'beta': loadBetaTesters(); break;
                case 'plans': loadPlans(); break;
                case 'feedback': loadFeedback(); break;
                case 'enterprise': loadEnterpriseInquiries(); break;
                case 'surge-settings': loadSurgeSettingsTab(); break;
            }
        }

        // Dashboard
        async function loadDashboard() {
            try {
                // Load all stats in parallel (use status=all for accurate total count)
                const [users, payments, beta, plans] = await Promise.all([
                    fetch(`${window.ADMIN_API_BASE}/users?status=all`, { headers: getHeaders() }).then(r => r.json()),
                    fetch(`${window.ADMIN_API_BASE}/payment-requests?status=pending`, { headers: getHeaders() }).then(r => r.json()),
                    fetch(`${window.ADMIN_API_BASE}/beta-testers`, { headers: getHeaders() }).then(r => r.json()),
                    fetch(`${window.ADMIN_API_BASE}/features/plans`, { headers: getHeaders() }).then(r => r.json())
                ]);

                // Update stats (check if elements exist first)
                const statTotalUsers = document.getElementById('statTotalUsers');
                if (statTotalUsers) {
                    statTotalUsers.textContent = users.count || 0;
                }

                const statPendingPayments = document.getElementById('statPendingPayments');
                if (statPendingPayments) {
                    statPendingPayments.textContent = payments.count || 0;
                }

                const statBetaTesters = document.getElementById('statBetaTesters');
                if (statBetaTesters) {
                    statBetaTesters.textContent = beta.testers?.length || 0;
                }

                // Calculate active subscriptions
                const activeSubscriptions = users.users?.filter(u =>
                    u.subscription_status === 'active' && u.plan_code !== 'free'
                ).length || 0;

                const statActiveSubscriptions = document.getElementById('statActiveSubscriptions');
                if (statActiveSubscriptions) {
                    statActiveSubscriptions.textContent = activeSubscriptions;
                }

                console.log('[Admin] Dashboard loaded successfully');

            } catch (error) {
                console.error('[Admin] Failed to load dashboard:', error);
            }
        }

        // Users
        async function loadUsers() {
            try {
                // Get filter value
                const statusFilter = document.getElementById('userStatusFilter').value;

                const response = await fetch(`${window.ADMIN_API_BASE}/users?status=${statusFilter}`, {
                    headers: getHeaders()
                });
                const data = await response.json();

                if (data.success) {
                    renderUsers(data.users);
                    console.log(`[Admin] Loaded ${data.users.length} users (filter: ${statusFilter})`);
                } else {
                    alert('사용자 로드 실패: ' + data.error);
                }
            } catch (error) {
                console.error('사용자 로드 실패:', error);
            }
        }

        function renderUsers(users) {
            const tbody = document.getElementById('usersTable');

            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">👥</div><div class="empty-state-text">해당 조건의 사용자가 없습니다</div></td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr class="${user.is_active ? '' : 'inactive-user'}">
                    <td>${user.email}</td>
                    <td>${user.username || '-'}</td>
                    <td><span class="badge badge-${getPlanBadge(user.plan_code)}">${(user.plan_code || 'FREE').toUpperCase()}</span></td>
                    <td><span class="badge badge-${user.is_active ? 'success' : 'danger'}">${user.is_active ? '활성' : '비활성'}</span></td>
                    <td><span class="badge badge-${user.has_upbit_keys ? 'success' : 'danger'}">${user.has_upbit_keys ? '✓ 등록됨' : '✗ 미등록'}</span></td>
                    <td>${user.expires_at ? new Date(user.expires_at).toLocaleDateString('ko-KR') : '<span style="color: #28a745; font-weight: 600;">♾️ 무제한</span>'}</td>
                    <td style="white-space: nowrap;">
                        <div class="dropdown" id="dropdown-${user.id}">
                            <button class="btn btn-warning" style="padding: 6px 12px; font-size: 12px; margin-right: 5px;" onclick="toggleDropdown(${user.id}, event)">⏱ 연장 ▼</button>
                            <div class="dropdown-content">
                                <button onclick="extendSubscription(${user.id}, 30, event)">1개월 (+30일)</button>
                                <button onclick="extendSubscription(${user.id}, 90, event)">3개월 (+90일)</button>
                                <button onclick="extendSubscription(${user.id}, 180, event)">6개월 (+180일)</button>
                                <button onclick="extendSubscription(${user.id}, 365, event)">1년 (+365일)</button>
                            </div>
                        </div>
                        <button class="btn btn-info" style="padding: 6px 12px; font-size: 12px; margin-right: 5px;" onclick="openSubscriptionModal(${user.id}, '${user.email}')">📋 상세</button>
                        <button class="btn btn-primary" style="padding: 6px 12px; font-size: 12px; margin-right: 5px;" onclick="editUser(${user.id}, '${user.email}', '${(user.plan_code || 'FREE').toUpperCase()}')">플랜 변경</button>
                        ${user.is_active
                            ? `<button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteUser(${user.id}, '${user.email}')">삭제</button>`
                            : `<button class="btn btn-success" style="padding: 6px 12px; font-size: 12px;" onclick="restoreUser(${user.id}, '${user.email}')">복원</button>`
                        }
                    </td>
                </tr>
            `).join('');
        }

        function getPlanBadge(plan) {
            const planLower = (plan || 'free').toLowerCase();
            const badges = {
                'free': 'info',
                'premium': 'success',
                'pro': 'warning'
            };
            return badges[planLower] || 'info';
        }

        function editUser(userId, email, plan) {
            document.getElementById('editUserId').value = userId;
            document.getElementById('editUserEmail').value = email;
            document.getElementById('editUserPlan').value = plan.toLowerCase();

            // Reset unlimited checkbox
            document.getElementById('editUnlimited').checked = false;
            document.getElementById('editDurationDays').disabled = false;
            document.getElementById('editDurationDays').value = '30';
            document.getElementById('editDurationDays').setAttribute('required', 'required');
            document.getElementById('durationHelp').textContent = '플랜 활성 기간 (기본: 30일)';
            document.getElementById('durationHelp').style.color = '';
            document.getElementById('durationHelp').style.fontWeight = '';

            openModal('userModal');
        }

        function toggleUnlimitedPeriod() {
            const unlimited = document.getElementById('editUnlimited').checked;
            const durationInput = document.getElementById('editDurationDays');
            const helpText = document.getElementById('durationHelp');

            if (unlimited) {
                durationInput.disabled = true;
                durationInput.value = '';
                durationInput.removeAttribute('required');
                durationInput.style.background = '#f8f9fa';
                helpText.textContent = '무제한 - 만료되지 않습니다';
                helpText.style.color = '#28a745';
                helpText.style.fontWeight = '600';
            } else {
                durationInput.disabled = false;
                durationInput.value = '30';
                durationInput.setAttribute('required', 'required');
                durationInput.style.background = '';
                helpText.textContent = '플랜 활성 기간 (기본: 30일)';
                helpText.style.color = '';
                helpText.style.fontWeight = '';
            }
        }

        function toggleSubUnlimitedPeriod() {
            const unlimited = document.getElementById('subUnlimited').checked;
            const endDateInput = document.getElementById('subEndDate');
            const helpText = document.getElementById('subEndDateHelp');

            if (unlimited) {
                endDateInput.disabled = true;
                endDateInput.value = '';
                endDateInput.removeAttribute('required');
                endDateInput.style.background = '#f8f9fa';
                helpText.textContent = '♾️ 무제한 - 만료되지 않습니다';
                helpText.style.color = '#28a745';
                helpText.style.fontWeight = '600';
            } else {
                endDateInput.disabled = false;
                endDateInput.setAttribute('required', 'required');
                endDateInput.style.background = '';
                helpText.textContent = '구독 만료 날짜';
                helpText.style.color = '';
                helpText.style.fontWeight = '';
            }
        }

        async function deleteUser(userId, email) {
            if (!confirm(`정말로 사용자 "${email}"를 삭제하시겠습니까?\n\n⚠️ 사용자 계정이 비활성화됩니다.`)) {
                return;
            }

            try {
                console.log(`[Admin] Deleting user ${userId} (${email})`);

                const response = await fetch(`${window.ADMIN_API_BASE}/users/${userId}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });

                console.log('[Admin] Delete response:', response.status);
                const data = await response.json();
                console.log('[Admin] Delete data:', data);

                if (data.success) {
                    alert('✓ 사용자가 성공적으로 비활성화되었습니다.\n\n"전체 사용자" 필터에서 확인할 수 있습니다.');

                    // 목록과 통계 모두 새로고침
                    await loadUsers();
                    await loadDashboard();

                    console.log('[Admin] User list refreshed after deletion');
                } else {
                    alert('❌ 사용자 삭제 실패: ' + data.error);
                }
            } catch (error) {
                console.error('[Admin] Delete error:', error);
                alert('❌ 사용자 삭제 중 오류가 발생했습니다.\n\n' + error.message);
            }
        }

        async function restoreUser(userId, email) {
            if (!confirm(`사용자 "${email}"를 복원하시겠습니까?\n\n계정이 다시 활성화됩니다.`)) {
                return;
            }

            try {
                console.log(`[Admin] Restoring user ${userId} (${email})`);

                const response = await fetch(`${window.ADMIN_API_BASE}/users/${userId}/restore`, {
                    method: 'POST',
                    headers: getHeaders()
                });

                console.log('[Admin] Restore response:', response.status);
                const data = await response.json();
                console.log('[Admin] Restore data:', data);

                if (data.success) {
                    alert('✓ 사용자가 성공적으로 복원되었습니다.');

                    // 목록과 통계 모두 새로고침
                    await loadUsers();
                    await loadDashboard();

                    console.log('[Admin] User list refreshed after restoration');
                } else {
                    alert('❌ 사용자 복원 실패: ' + data.error);
                }
            } catch (error) {
                console.error('[Admin] Restore error:', error);
                alert('❌ 사용자 복원 중 오류가 발생했습니다.\n\n' + error.message);
            }
        }

        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const userId = document.getElementById('editUserId').value;
            const planCode = document.getElementById('editUserPlan').value;
            const unlimited = document.getElementById('editUnlimited').checked;
            const durationDays = unlimited ? null : parseInt(document.getElementById('editDurationDays').value);
            const notes = document.getElementById('editNotes').value;

            const confirmMsg = unlimited
                ? `${planCode} 플랜을 무제한으로 활성화하시겠습니까?`
                : `${planCode} 플랜을 ${durationDays}일 동안 활성화하시겠습니까?`;

            if (!confirm(confirmMsg)) {
                return;
            }

            try {
                const response = await fetch(`${window.ADMIN_API_BASE}/users/${userId}/plan`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        plan_code: planCode,
                        duration_days: durationDays,
                        notes: notes
                    })
                });

                const data = await response.json();

                if (data.success) {
                    closeModal('userModal');
                    loadUsers();
                    loadDashboard();

                    const expiryMsg = data.expires_at
                        ? `만료일: ${new Date(data.expires_at).toLocaleDateString('ko-KR')}`
                        : '만료일: ♾️ 무제한';

                    alert(`✓ ${planCode} 플랜이 활성화되었습니다!\n${expiryMsg}`);
                } else {
                    alert('실패: ' + data.error);
                }
            } catch (error) {
                alert('오류: ' + error.message);
            }
        });

        function filterUsers() {
            const search = document.getElementById('userSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#usersTable tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        // Payments
        async function loadPayments() {
            const status = document.getElementById('paymentStatusFilter').value;
            const queryStatus = status === 'all' ? '' : `?status=${status}`;

            try {
                const response = await fetch(`${window.ADMIN_API_BASE}/payment-requests${queryStatus}`, { headers: getHeaders() });
                const data = await response.json();

                if (data.success) {
                    renderPayments(data.requests);
                } else {
                    alert('결제 내역 로드 실패: ' + data.error);
                }
            } catch (error) {
                console.error('결제 내역 로드 실패:', error);
            }
        }

        function renderPayments(payments) {
            const tbody = document.getElementById('paymentsTable');

            if (!payments || payments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">💳</div><div class="empty-state-text">결제 요청이 없습니다</div></td></tr>';
                return;
            }

            tbody.innerHTML = payments.map(payment => `
                <tr>
                    <td><strong>${payment.payment_code}</strong></td>
                    <td>${payment.email}</td>
                    <td><span class="badge badge-${getPlanBadge(payment.plan_code)}">${payment.plan_code}</span></td>
                    <td>₩${payment.amount.toLocaleString()}</td>
                    <td><span class="badge badge-${getStatusBadge(payment.status)}">${payment.status}</span></td>
                    <td>${new Date(payment.created_at).toLocaleDateString()}</td>
                    <td>
                        ${payment.status === 'pending' ? `
                            <button class="btn btn-success" style="padding: 6px 12px; font-size: 12px;" onclick="showPaymentDetails(${payment.id})">검토</button>
                        ` : '-'}
                    </td>
                </tr>
            `).join('');
        }

        function getStatusBadge(status) {
            const badges = { 'pending': 'warning', 'approved': 'success', 'rejected': 'danger' };
            return badges[status] || 'info';
        }

        function showPaymentDetails(paymentId) {
            window.currentPaymentId = paymentId;
            // In a real app, fetch payment details
            document.getElementById('paymentDetails').innerHTML = `
                <div class="form-group">
                    <label>결제 ID</label>
                    <p>${paymentId}</p>
                </div>
                <p>이 결제 요청을 검토한 후 승인 또는 거부하세요.</p>
            `;
            openModal('paymentModal');
        }

        async function approvePayment() {
            if (!window.currentPaymentId) return;

            try {
                const response = await fetch(`${window.ADMIN_API_BASE}/payment-requests/${window.currentPaymentId}/approve`, {
                    method: 'POST',
                    headers: getHeaders()
                });

                const data = await response.json();

                if (data.success) {
                    closeModal('paymentModal');
                    loadPayments();
                    loadDashboard();
                    alert('✓ 결제가 승인되었습니다!');
                } else {
                    alert('실패: ' + data.error);
                }
            } catch (error) {
                alert('오류: ' + error.message);
            }
        }

        function rejectPayment() {
            alert('거부 기능은 곧 구현될 예정입니다');
        }

        function filterPayments() {
            const search = document.getElementById('paymentSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#paymentsTable tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        // Beta Testers
        async function loadBetaTesters() {
            try {
                const response = await fetch(`${window.ADMIN_API_BASE}/beta-testers`, { headers: getHeaders() });
                const data = await response.json();

                if (data.success) {
                    renderBetaTesters(data.testers);
                } else {
                    alert('베타 테스터 로드 실패: ' + data.error);
                }
            } catch (error) {
                console.error('베타 테스터 로드 실패:', error);
            }
        }

        function renderBetaTesters(testers) {
            const tbody = document.getElementById('betaTable');

            if (!testers || testers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><div class="empty-state-icon">🧪</div><div class="empty-state-text">아직 베타 테스터가 없습니다</div></td></tr>';
                return;
            }

            tbody.innerHTML = testers.map(tester => `
                <tr>
                    <td>${tester.email}</td>
                    <td>${tester.name || '-'}</td>
                    <td><span class="badge badge-${tester.is_active ? 'success' : 'danger'}">${tester.is_active ? '활성' : '비활성'}</span></td>
                    <td>${new Date(tester.joined_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteBetaTester(${tester.id})">삭제</button>
                    </td>
                </tr>
            `).join('');
        }

        function openAddBetaModal() {
            openModal('betaModal');
        }

        document.getElementById('betaForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                email: document.getElementById('betaEmail').value,
                name: document.getElementById('betaName').value
            };

            try {
                const response = await fetch(`${window.ADMIN_API_BASE}/beta-tester`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    closeModal('betaModal');
                    loadBetaTesters();
                    loadDashboard();
                    document.getElementById('betaForm').reset();
                    alert('✓ 베타 테스터가 추가되었습니다!');
                } else {
                    alert('실패: ' + data.error);
                }
            } catch (error) {
                alert('오류: ' + error.message);
            }
        });

        async function deleteBetaTester(id) {
            if (!confirm('이 베타 테스터를 삭제하시겠습니까?')) return;

            try {
                const response = await fetch(`${window.ADMIN_API_BASE}/beta-tester/${id}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });

                const data = await response.json();

                if (data.success) {
                    loadBetaTesters();
                    loadDashboard();
                    alert('✓ 베타 테스터가 삭제되었습니다!');
                } else {
                    alert('실패: ' + data.error);
                }
            } catch (error) {
                alert('오류: ' + error.message);
            }
        }

        function filterBeta() {
            const search = document.getElementById('betaSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#betaTable tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        // Plans
        async function loadPlans() {
            try {
                const response = await fetch(`${window.ADMIN_API_BASE}/features/plans`, { headers: getHeaders() });
                const data = await response.json();

                if (data.success) {
                    // Convert plans object to array format
                    const plansArray = Object.entries(data.plans).map(([code, features]) => ({
                        plan_code: code,
                        plan_name_ko: code.toUpperCase(),
                        description: `${code} 플랜`,
                        price: { monthly: 0 }, // Placeholder, real pricing would come from backend
                        display: { is_active: true }
                    }));
                    renderPlans(plansArray);
                } else {
                    alert('플랜 로드 실패: ' + data.error);
                }
            } catch (error) {
                console.error('플랜 로드 실패:', error);
            }
        }

        function renderPlans(plans) {
            const tbody = document.getElementById('plansTable');

            if (!plans || plans.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><div class="empty-state-icon">💎</div><div class="empty-state-text">설정된 플랜이 없습니다</div></td></tr>';
                return;
            }

            tbody.innerHTML = plans.map(plan => `
                <tr>
                    <td><strong>${plan.plan_name_ko}</strong> (${plan.plan_code})</td>
                    <td>₩${plan.price.monthly.toLocaleString()}/월</td>
                    <td>${plan.description}</td>
                    <td><span class="badge badge-${plan.display.is_active ? 'success' : 'danger'}">${plan.display.is_active ? '활성' : '비활성'}</span></td>
                    <td>-</td>
                </tr>
            `).join('');
        }

        // Modal Management
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Subscription Management Functions

        // Toggle dropdown menu
        function toggleDropdown(userId, event) {
            event.stopPropagation();
            const dropdown = document.getElementById(`dropdown-${userId}`);

            // Close all other dropdowns
            document.querySelectorAll('.dropdown').forEach(d => {
                if (d.id !== `dropdown-${userId}`) {
                    d.classList.remove('active');
                }
            });

            dropdown.classList.toggle('active');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (event) => {
            if (!event.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('active'));
            }
        });

        // Quick extend subscription
        async function extendSubscription(userId, days, event) {
            event.stopPropagation();

            const periods = {
                30: '1개월',
                90: '3개월',
                180: '6개월',
                365: '1년'
            };

            if (!confirm(`구독 기간을 ${periods[days]} 연장하시겠습니까?\n(+${days}일)`)) {
                return;
            }

            try {
                console.log(`[Admin] Extending subscription for user ${userId} by ${days} days`);

                const response = await fetch(`${window.location.origin}/api/admin/subscriptions/users/${userId}/extend`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        days: days,
                        reason: `Admin quick extend: ${periods[days]}`
                    })
                });

                const data = await response.json();
                console.log('[Admin] Extend response:', data);

                if (data.success) {
                    const newEndDate = new Date(data.new_end_date).toLocaleDateString('ko-KR');
                    alert(`✓ 구독이 ${periods[days]} 연장되었습니다!\n\n새 만료일: ${newEndDate}`);

                    // Refresh user list
                    await loadUsers();
                    await loadDashboard();
                } else {
                    alert(`❌ 구독 연장 실패: ${data.error}\n\n구독이 없는 경우 먼저 "플랜 변경"을 통해 구독을 생성해주세요.`);
                }
            } catch (error) {
                console.error('[Admin] Extend error:', error);
                alert(`❌ 구독 연장 중 오류가 발생했습니다.\n\n${error.message}`);
            }

            // Close dropdown
            document.getElementById(`dropdown-${userId}`).classList.remove('active');
        }

        // Open subscription detail modal
        async function openSubscriptionModal(userId, email) {
            try {
                console.log(`[Admin] Loading subscription details for user ${userId}`);

                // Fetch subscription details
                const response = await fetch(`${window.location.origin}/api/admin/subscriptions/users/${userId}`, {
                    headers: getHeaders()
                });

                const data = await response.json();
                console.log('[Admin] Subscription data:', data);

                // Populate form
                document.getElementById('subUserId').value = userId;
                document.getElementById('subUserEmail').value = email;

                if (data.subscription) {
                    const sub = data.subscription;

                    // Set values
                    document.getElementById('subPlan').value = sub.plan || 'free';
                    document.getElementById('subStatus').value = sub.status || 'active';
                    document.getElementById('subBillingPeriod').value = sub.billing_period || 'monthly';

                    // Convert ISO datetime to local datetime-local format
                    if (sub.current_period_start) {
                        const startDate = new Date(sub.current_period_start);
                        document.getElementById('subStartDate').value = startDate.toISOString().slice(0, 16);
                    } else {
                        document.getElementById('subStartDate').value = new Date().toISOString().slice(0, 16);
                    }

                    if (sub.current_period_end) {
                        const endDate = new Date(sub.current_period_end);
                        document.getElementById('subEndDate').value = endDate.toISOString().slice(0, 16);
                        document.getElementById('subUnlimited').checked = false;
                        document.getElementById('subEndDate').disabled = false;
                        document.getElementById('subEndDate').style.background = '';
                    } else {
                        // No end date = unlimited
                        document.getElementById('subUnlimited').checked = true;
                        document.getElementById('subEndDate').value = '';
                        document.getElementById('subEndDate').disabled = true;
                        document.getElementById('subEndDate').removeAttribute('required');
                        document.getElementById('subEndDate').style.background = '#f8f9fa';
                        document.getElementById('subEndDateHelp').textContent = '♾️ 무제한 - 만료되지 않습니다';
                        document.getElementById('subEndDateHelp').style.color = '#28a745';
                        document.getElementById('subEndDateHelp').style.fontWeight = '600';
                    }
                } else {
                    // No subscription - set defaults
                    document.getElementById('subPlan').value = 'free';
                    document.getElementById('subStatus').value = 'active';
                    document.getElementById('subBillingPeriod').value = 'monthly';

                    const now = new Date();
                    document.getElementById('subStartDate').value = now.toISOString().slice(0, 16);

                    const defaultEnd = new Date();
                    defaultEnd.setMonth(defaultEnd.getMonth() + 1);
                    document.getElementById('subEndDate').value = defaultEnd.toISOString().slice(0, 16);

                    console.log('[Admin] No subscription found - using defaults');
                }

                openModal('subscriptionModal');

            } catch (error) {
                console.error('[Admin] Failed to load subscription:', error);
                alert('❌ 구독 정보를 불러오는데 실패했습니다.\n\n' + error.message);
            }
        }

        // Save subscription details
        document.getElementById('subscriptionForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const userId = document.getElementById('subUserId').value;
            const plan = document.getElementById('subPlan').value;
            const billingPeriod = document.getElementById('subBillingPeriod').value;
            const startDate = document.getElementById('subStartDate').value;
            const unlimited = document.getElementById('subUnlimited').checked;
            const endDate = unlimited ? null : document.getElementById('subEndDate').value;
            const reason = document.getElementById('subReason').value || 'Admin subscription update';

            if (!confirm('구독 정보를 저장하시겠습니까?')) {
                return;
            }

            try {
                console.log(`[Admin] Updating subscription for user ${userId}`);

                // Step 1: Change plan (creates/updates subscription)
                const planResponse = await fetch(`${window.location.origin}/api/admin/subscriptions/users/${userId}/plan`, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        plan: plan,
                        billing_period: billingPeriod,
                        reason: reason
                    })
                });

                const planData = await planResponse.json();
                console.log('[Admin] Plan change response:', planData);

                if (!planData.success) {
                    alert(`❌ 플랜 변경 실패: ${planData.error}`);
                    return;
                }

                // Step 2: Set custom period dates
                const periodResponse = await fetch(`${window.location.origin}/api/admin/subscriptions/users/${userId}/custom-period`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        start_date: new Date(startDate).toISOString(),
                        end_date: new Date(endDate).toISOString(),
                        reason: reason
                    })
                });

                const periodData = await periodResponse.json();
                console.log('[Admin] Custom period response:', periodData);

                if (periodData.success) {
                    closeModal('subscriptionModal');
                    await loadUsers();
                    await loadDashboard();

                    const endDateStr = new Date(endDate).toLocaleDateString('ko-KR');
                    alert(`✓ 구독 정보가 저장되었습니다!\n\n플랜: ${plan.toUpperCase()}\n만료일: ${endDateStr}`);
                } else {
                    alert(`⚠️ 플랜은 변경되었으나 기간 설정에 실패했습니다.\n\n${periodData.error}`);
                }

            } catch (error) {
                console.error('[Admin] Subscription save error:', error);
                alert(`❌ 구독 정보 저장 중 오류가 발생했습니다.\n\n${error.message}`);
            }
        });

        // Feedback Management
        let cachedFeedbackList = []; // Cache to prevent rate limit errors

        async function loadFeedback() {
            try {
                const typeFilter = document.getElementById('feedbackTypeFilter').value;
                const statusFilter = document.getElementById('feedbackStatusFilter').value;
                const priorityFilter = document.getElementById('feedbackPriorityFilter').value;

                let url = `${window.location.origin}/api/feedback/admin?`;
                if (typeFilter) url += `type=${typeFilter}&`;
                if (statusFilter) url += `status=${statusFilter}&`;
                if (priorityFilter) url += `priority=${priorityFilter}&`;

                const response = await fetch(url, { headers: getHeaders() });
                const data = await response.json();

                if (data.success) {
                    cachedFeedbackList = data.feedback; // Store in cache
                    renderFeedback(data.feedback);
                } else {
                    alert('피드백 로드 실패: ' + data.error);
                }
            } catch (error) {
                console.error('피드백 로드 실패:', error);
                document.getElementById('feedbackTable').innerHTML = '<tr><td colspan="8" class="error-state"><div class="error-state-icon">⚠️</div><div class="error-state-text">피드백을 불러오는데 실패했습니다</div></td></tr>';
            }
        }

        function renderFeedback(feedbackList) {
            const tbody = document.getElementById('feedbackTable');

            if (!feedbackList || feedbackList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><div class="empty-state-icon">💬</div><div class="empty-state-text">피드백이 없습니다</div></td></tr>';
                return;
            }

            const typeEmoji = { 'bug': '🐛', 'feature': '💡', 'general': '💭' };
            const priorityEmoji = { 'urgent': '🚨', 'high': '⚠️', 'normal': 'ℹ️', 'low': '💬' };
            const statusEmoji = { 'new': '🆕', 'in_progress': '⏳', 'resolved': '✅', 'closed': '🔒' };
            const statusClass = { 'new': 'primary', 'in_progress': 'warning', 'resolved': 'success', 'closed': 'secondary' };

            tbody.innerHTML = feedbackList.map(feedback => `
                <tr>
                    <td>#${feedback.id}</td>
                    <td>${typeEmoji[feedback.type] || ''} ${feedback.type}</td>
                    <td>${priorityEmoji[feedback.priority] || ''} ${feedback.priority}</td>
                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${feedback.subject}</td>
                    <td>${feedback.user ? feedback.user.username : 'Unknown'}</td>
                    <td><span class="badge badge-${statusClass[feedback.status]}">${statusEmoji[feedback.status] || ''} ${feedback.status}</span></td>
                    <td>${new Date(feedback.created_at).toLocaleString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewFeedback(${feedback.id})">상세</button>
                    </td>
                </tr>
            `).join('');
        }

        function filterFeedback() {
            const search = document.getElementById('feedbackSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#feedbackTable tr:not(.loading):not(.empty-state):not(.error-state)');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        async function viewFeedback(feedbackId) {
            try {
                // Use cached data to prevent rate limit errors
                const feedback = cachedFeedbackList.find(f => f.id === feedbackId);

                if (!feedback) {
                    alert('피드백을 찾을 수 없습니다');
                    return;
                }

                const typeEmoji = { 'bug': '🐛', 'feature': '💡', 'general': '💭' };
                const priorityEmoji = { 'urgent': '🚨', 'high': '⚠️', 'normal': 'ℹ️', 'low': '💬' };

                // Populate details
                document.getElementById('feedbackDetails').innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <p style="margin-bottom: 12px;"><strong>ID:</strong> #${feedback.id}</p>
                        <p style="margin-bottom: 12px;"><strong>유형:</strong> ${typeEmoji[feedback.type] || ''} ${feedback.type}</p>
                        <p style="margin-bottom: 12px;"><strong>우선순위:</strong> ${priorityEmoji[feedback.priority] || ''} ${feedback.priority}</p>
                        <p style="margin-bottom: 12px;"><strong>제목:</strong> ${feedback.subject}</p>
                        <p style="margin-bottom: 12px;"><strong>사용자:</strong> ${feedback.user ? `${feedback.user.username} (${feedback.user.email})` : 'Unknown'}</p>
                        <p style="margin-bottom: 12px;"><strong>생성일:</strong> ${new Date(feedback.created_at).toLocaleString('ko-KR')}</p>
                        <p style="margin-bottom: 12px;"><strong>내용:</strong></p>
                        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; white-space: pre-wrap; margin-bottom: 16px;">${feedback.content}</div>
                        ${feedback.screenshot_url ? `<p style="margin-bottom: 12px;"><strong>스크린샷:</strong> <a href="${feedback.screenshot_url}" target="_blank">${feedback.screenshot_url}</a></p>` : ''}
                    </div>
                `;

                // Populate form
                document.getElementById('feedbackId').value = feedback.id;
                document.getElementById('feedbackStatus').value = feedback.status;
                document.getElementById('feedbackAdminNotes').value = feedback.admin_notes || '';

                openModal('feedbackModal');
            } catch (error) {
                console.error('피드백 상세 로드 실패:', error);
                alert('피드백 상세를 불러오는데 실패했습니다');
            }
        }

        // Update feedback
        document.getElementById('feedbackForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const feedbackId = document.getElementById('feedbackId').value;
            const status = document.getElementById('feedbackStatus').value;
            const adminNotes = document.getElementById('feedbackAdminNotes').value;

            if (!confirm('피드백을 업데이트하시겠습니까?')) {
                return;
            }

            try {
                const response = await fetch(`${window.location.origin}/api/feedback/admin/${feedbackId}`, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify({ status, admin_notes: adminNotes })
                });

                const data = await response.json();

                if (data.success) {
                    alert('✓ 피드백이 업데이트되었습니다');
                    closeModal('feedbackModal');
                    await loadFeedback();
                } else {
                    alert('❌ 피드백 업데이트 실패: ' + data.error);
                }
            } catch (error) {
                console.error('피드백 업데이트 실패:', error);
                alert('❌ 피드백 업데이트 중 오류가 발생했습니다');
            }
        });

        async function deleteFeedback() {
            const feedbackId = document.getElementById('feedbackId').value;

            if (!confirm('⚠️ 이 피드백을 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.')) {
                return;
            }

            try {
                const response = await fetch(`${window.location.origin}/api/feedback/admin/${feedbackId}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });

                const data = await response.json();

                if (data.success) {
                    alert('✓ 피드백이 삭제되었습니다');
                    closeModal('feedbackModal');
                    await loadFeedback();
                } else {
                    alert('❌ 피드백 삭제 실패: ' + data.error);
                }
            } catch (error) {
                console.error('피드백 삭제 실패:', error);
                alert('❌ 피드백 삭제 중 오류가 발생했습니다');
            }
        }

        // Auto refresh every 30 seconds
        setInterval(loadDashboard, 30000);

        // ===== Enterprise Inquiries Management =====
        window.allEnterpriseInquiries = window.allEnterpriseInquiries || [];

        async function loadEnterpriseInquiries() {
            const tbody = document.getElementById('enterpriseTable');
            const statusFilter = document.getElementById('enterpriseStatusFilter').value;

            try {
                let url = `${window.location.origin}/api/enterprise/inquiries?per_page=100`;
                if (statusFilter) {
                    url += `&status=${statusFilter}`;
                }

                const response = await fetch(url, { headers: getHeaders() });
                const data = await response.json();

                if (data.success) {
                    window.allEnterpriseInquiries = data.inquiries;
                    displayEnterpriseInquiries(window.allEnterpriseInquiries);
                } else {
                    tbody.innerHTML = '<tr><td colspan="9" class="error-state"><div class="error-state-icon">⚠️</div><div class="error-state-text">상담 신청을 불러오는데 실패했습니다</div></td></tr>';
                }
            } catch (error) {
                console.error('Enterprise inquiries 로드 실패:', error);
                tbody.innerHTML = '<tr><td colspan="9" class="error-state"><div class="error-state-icon">⚠️</div><div class="error-state-text">상담 신청을 불러오는데 실패했습니다</div></td></tr>';
            }
        }

        function displayEnterpriseInquiries(inquiries) {
            const tbody = document.getElementById('enterpriseTable');

            if (inquiries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state"><div class="empty-state-icon">⭐</div><div class="empty-state-text">Enterprise 상담 신청이 없습니다</div></td></tr>';
                return;
            }

            tbody.innerHTML = inquiries.map(inquiry => {
                const statusBadge = getEnterpriseStatusBadge(inquiry.status);
                const volumeText = getTradingVolumeText(inquiry.trading_volume);
                const createdDate = new Date(inquiry.created_at).toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                return `
                    <tr>
                        <td><strong>#${inquiry.id}</strong></td>
                        <td>${inquiry.name}</td>
                        <td>${inquiry.company || '-'}</td>
                        <td><a href="mailto:${inquiry.email}">${inquiry.email}</a></td>
                        <td><a href="tel:${inquiry.phone}">${inquiry.phone}</a></td>
                        <td>${volumeText}</td>
                        <td>${statusBadge}</td>
                        <td>${createdDate}</td>
                        <td>
                            <button class="btn btn-info" onclick="openEnterpriseModal(${inquiry.id})" style="padding: 8px 16px; font-size: 13px;">상세보기</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getEnterpriseStatusBadge(status) {
            const badges = {
                'pending': '<span class="badge" style="background: #ffc107; color: #212529;">⏳ 대기</span>',
                'contacted': '<span class="badge" style="background: #17a2b8; color: white;">📞 연락완료</span>',
                'converted': '<span class="badge" style="background: #28a745; color: white;">✅ 계약완료</span>',
                'rejected': '<span class="badge" style="background: #dc3545; color: white;">❌ 거절</span>'
            };
            return badges[status] || status;
        }

        function getTradingVolumeText(volume) {
            const texts = {
                'under_10m': '1,000만원 미만',
                '10m_50m': '1,000만원~5,000만원',
                '50m_100m': '5,000만원~1억원',
                '100m_500m': '1억원~5억원',
                'over_500m': '5억원 이상'
            };
            return texts[volume] || volume;
        }

        async function openEnterpriseModal(inquiryId) {
            try {
                const response = await fetch(`${window.location.origin}/api/enterprise/inquiry/${inquiryId}`, {
                    headers: getHeaders()
                });

                const data = await response.json();

                if (data.success) {
                    const inquiry = data.inquiry;

                    // Display details
                    const detailsHtml = `
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                            <div>
                                <strong style="color: #667eea;">신청자 정보</strong>
                                <div style="margin-top: 8px; line-height: 1.8;">
                                    <div>👤 <strong>이름:</strong> ${inquiry.name}</div>
                                    <div>📧 <strong>이메일:</strong> <a href="mailto:${inquiry.email}">${inquiry.email}</a></div>
                                    <div>📱 <strong>전화:</strong> <a href="tel:${inquiry.phone}">${inquiry.phone}</a></div>
                                    <div>🏢 <strong>회사:</strong> ${inquiry.company || '-'}</div>
                                </div>
                            </div>
                            <div>
                                <strong style="color: #667eea;">거래 정보</strong>
                                <div style="margin-top: 8px; line-height: 1.8;">
                                    <div>💰 <strong>월 거래량:</strong> ${getTradingVolumeText(inquiry.trading_volume)}</div>
                                    <div>📅 <strong>신청일:</strong> ${new Date(inquiry.created_at).toLocaleString('ko-KR')}</div>
                                    <div>🔄 <strong>업데이트:</strong> ${new Date(inquiry.updated_at).toLocaleString('ko-KR')}</div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 20px;">
                            <strong style="color: #667eea;">문의 내용</strong>
                            <div style="margin-top: 8px; padding: 16px; background: white; border-radius: 8px; line-height: 1.6; white-space: pre-wrap;">${inquiry.message}</div>
                        </div>
                        ${inquiry.contacted_at ? `<div style="margin-top: 12px;"><strong>연락일:</strong> ${new Date(inquiry.contacted_at).toLocaleString('ko-KR')}</div>` : ''}
                        ${inquiry.converted_at ? `<div style="margin-top: 12px;"><strong>계약일:</strong> ${new Date(inquiry.converted_at).toLocaleString('ko-KR')}</div>` : ''}
                    `;

                    document.getElementById('enterpriseDetails').innerHTML = detailsHtml;
                    document.getElementById('enterpriseId').value = inquiry.id;
                    document.getElementById('enterpriseStatus').value = inquiry.status;
                    document.getElementById('enterpriseAdminNote').value = inquiry.admin_note || '';

                    openModal('enterpriseModal');
                } else {
                    alert('❌ 상담 신청 정보를 불러오는데 실패했습니다');
                }
            } catch (error) {
                console.error('Enterprise inquiry 로드 실패:', error);
                alert('❌ 상담 신청 정보를 불러오는데 실패했습니다');
            }
        }

        // Update enterprise inquiry status
        document.getElementById('enterpriseForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const inquiryId = document.getElementById('enterpriseId').value;
            const status = document.getElementById('enterpriseStatus').value;
            const adminNote = document.getElementById('enterpriseAdminNote').value;

            try {
                const response = await fetch(`${window.location.origin}/api/enterprise/inquiry/${inquiryId}/status`, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        status: status,
                        admin_note: adminNote
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('✓ 상태가 업데이트되었습니다');
                    closeModal('enterpriseModal');
                    await loadEnterpriseInquiries();
                } else {
                    alert('❌ 상태 업데이트 실패: ' + data.message);
                }
            } catch (error) {
                console.error('상태 업데이트 실패:', error);
                alert('❌ 상태 업데이트 중 오류가 발생했습니다');
            }
        });

        function filterEnterpriseInquiries() {
            const searchTerm = document.getElementById('enterpriseSearch').value.toLowerCase();

            if (!searchTerm) {
                displayEnterpriseInquiries(window.allEnterpriseInquiries);
                return;
            }

            const filtered = window.allEnterpriseInquiries.filter(inquiry => {
                return inquiry.name.toLowerCase().includes(searchTerm) ||
                       inquiry.email.toLowerCase().includes(searchTerm) ||
                       inquiry.phone.includes(searchTerm) ||
                       (inquiry.company && inquiry.company.toLowerCase().includes(searchTerm)) ||
                       inquiry.message.toLowerCase().includes(searchTerm);
            });

            displayEnterpriseInquiries(filtered);
        }

        // ===== Surge Settings Management =====
        function showSurgeAlert(message, type = 'info') {
            const container = document.getElementById('surge-alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.marginBottom = '20px';
            container.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        async function loadSurgeStatus() {
            try {
                const response = await fetch(`${window.location.origin}/api/admin/surge/status`, {
                    headers: getHeaders()
                });

                const data = await response.json();

                if (data.success) {
                    const status = data.status;

                    document.getElementById('surge-worker-status').textContent =
                        status.worker_running ? '실행 중' : '중지됨';

                    const workerBadge = document.getElementById('surge-worker-badge');
                    workerBadge.className = `status-badge ${status.worker_running ? 'active' : 'inactive'}`;
                    workerBadge.innerHTML = `
                        <span class="status-indicator"></span>
                        ${status.worker_running ? '실행 중' : '중지됨'}
                    `;

                    document.getElementById('surge-active-signals').textContent = status.active_signals;
                    document.getElementById('surge-monitored-coins').textContent = status.monitored_coins;

                    if (status.last_scan) {
                        const date = new Date(status.last_scan);
                        document.getElementById('surge-last-scan').textContent =
                            date.toLocaleString('ko-KR', {
                                month: 'short',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                    }
                }
            } catch (error) {
                console.error('[Admin] Load surge status error:', error);
            }
        }

        async function loadSurgeSettings() {
            try {
                const response = await fetch(`${window.location.origin}/api/admin/surge/settings`, {
                    headers: getHeaders()
                });

                const data = await response.json();

                if (data.success && data.settings) {
                    const s = data.settings;
                    const config = s.analysis_config || {};

                    document.getElementById('surge-base-min-score').value = s.base_min_score;
                    document.getElementById('surge-telegram-min-score').value = s.telegram_min_score;
                    document.getElementById('surge-db-save-threshold').value = s.db_save_threshold;
                    document.getElementById('surge-check-interval').value = s.check_interval;
                    document.getElementById('surge-monitor-coins-count').value = s.monitor_coins_count;
                    document.getElementById('surge-duplicate-alert-hours').value = s.duplicate_alert_hours;
                    document.getElementById('surge-volume-threshold').value = config.volume_increase_threshold || 1.5;
                    document.getElementById('surge-rsi-oversold').value = config.rsi_oversold_level || 35;
                    document.getElementById('surge-rsi-buy-zone').value = config.rsi_buy_zone_max || 50;
                    document.getElementById('surge-support-proximity').value = config.support_level_proximity || 0.02;
                    document.getElementById('surge-uptrend-days').value = config.uptrend_confirmation_days || 3;
                    document.getElementById('surge-min-surge-score').value = config.min_surge_probability_score || 60;

                    displaySurgeCurrentSettings(s);
                    showSurgeAlert('설정을 불러왔습니다', 'success');
                }
            } catch (error) {
                console.error('[Admin] Load surge settings error:', error);
                showSurgeAlert('설정 불러오기 실패: ' + error.message, 'error');
            }
        }

        function displaySurgeCurrentSettings(settings) {
            const container = document.getElementById('surge-current-settings');
            const config = settings.analysis_config || {};

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                    <div>
                        <h3 style="margin-bottom: 10px; color: #374151;">신호 감지 기준</h3>
                        <div class="param-row">
                            <span class="param-label">시스템 최소 점수</span>
                            <span class="param-value">${settings.base_min_score}점</span>
                        </div>
                        <div class="param-row">
                            <span class="param-label">텔레그램 알림 점수</span>
                            <span class="param-value">${settings.telegram_min_score}점</span>
                        </div>
                        <div class="param-row">
                            <span class="param-label">DB 저장 기준</span>
                            <span class="param-value">${settings.db_save_threshold}점</span>
                        </div>
                    </div>
                    <div>
                        <h3 style="margin-bottom: 10px; color: #374151;">Worker 설정</h3>
                        <div class="param-row">
                            <span class="param-label">체크 주기</span>
                            <span class="param-value">${settings.check_interval}초 (${Math.floor(settings.check_interval/60)}분)</span>
                        </div>
                        <div class="param-row">
                            <span class="param-label">모니터링 코인</span>
                            <span class="param-value">${settings.monitor_coins_count}개</span>
                        </div>
                        <div class="param-row">
                            <span class="param-label">중복 방지</span>
                            <span class="param-value">${settings.duplicate_alert_hours}시간</span>
                        </div>
                    </div>
                    <div>
                        <h3 style="margin-bottom: 10px; color: #374151;">메타 정보</h3>
                        <div class="param-row">
                            <span class="param-label">마지막 수정</span>
                            <span class="param-value">${new Date(settings.updated_at).toLocaleString('ko-KR')}</span>
                        </div>
                        <div class="param-row">
                            <span class="param-label">수정자</span>
                            <span class="param-value">${settings.updated_by || '-'}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        async function saveSurgeSettings() {
            if (!confirm('설정을 저장하시겠습니까?\n서버 재시작 후 적용됩니다.')) {
                return;
            }

            try {
                const settings = {
                    base_min_score: parseInt(document.getElementById('surge-base-min-score').value),
                    telegram_min_score: parseInt(document.getElementById('surge-telegram-min-score').value),
                    db_save_threshold: parseInt(document.getElementById('surge-db-save-threshold').value),
                    check_interval: parseInt(document.getElementById('surge-check-interval').value),
                    monitor_coins_count: parseInt(document.getElementById('surge-monitor-coins-count').value),
                    duplicate_alert_hours: parseInt(document.getElementById('surge-duplicate-alert-hours').value),
                    analysis_config: {
                        volume_increase_threshold: parseFloat(document.getElementById('surge-volume-threshold').value),
                        rsi_oversold_level: parseInt(document.getElementById('surge-rsi-oversold').value),
                        rsi_buy_zone_max: parseInt(document.getElementById('surge-rsi-buy-zone').value),
                        support_level_proximity: parseFloat(document.getElementById('surge-support-proximity').value),
                        uptrend_confirmation_days: parseInt(document.getElementById('surge-uptrend-days').value),
                        min_surge_probability_score: parseInt(document.getElementById('surge-min-surge-score').value)
                    },
                    notes: `Updated via admin panel at ${new Date().toISOString()}`
                };

                const response = await fetch(`${window.location.origin}/api/admin/surge/settings`, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify(settings)
                });

                const data = await response.json();

                if (data.success) {
                    showSurgeAlert('설정이 저장되었습니다! 서버를 재시작하여 적용하세요.', 'success');
                    await loadSurgeSettings();
                } else {
                    throw new Error(data.error || '설정 저장 실패');
                }
            } catch (error) {
                console.error('[Admin] Save surge settings error:', error);
                showSurgeAlert('설정 저장 실패: ' + error.message, 'error');
            }
        }

        function resetSurgeToDefaults() {
            if (!confirm('기본값으로 초기화하시겠습니까?')) {
                return;
            }

            document.getElementById('surge-base-min-score').value = 60;
            document.getElementById('surge-telegram-min-score').value = 70;
            document.getElementById('surge-db-save-threshold').value = 60;
            document.getElementById('surge-check-interval').value = 300;
            document.getElementById('surge-monitor-coins-count').value = 50;
            document.getElementById('surge-duplicate-alert-hours').value = 24;
            document.getElementById('surge-volume-threshold').value = 1.5;
            document.getElementById('surge-rsi-oversold').value = 35;
            document.getElementById('surge-rsi-buy-zone').value = 50;
            document.getElementById('surge-support-proximity').value = 0.02;
            document.getElementById('surge-uptrend-days').value = 3;
            document.getElementById('surge-min-surge-score').value = 60;

            showSurgeAlert('기본값으로 초기화되었습니다. 저장 버튼을 눌러 적용하세요.', 'info');
        }

        async function loadSurgeSettingsTab() {
            await loadSurgeSettings();
            await loadSurgeStatus();

            if (window.surgeStatusInterval) {
                clearInterval(window.surgeStatusInterval);
            }
            window.surgeStatusInterval = setInterval(loadSurgeStatus, 30000);
        }
    </script>
</body>
</html>
