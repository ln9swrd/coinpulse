<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>대시보드 개요 - CoinPulse</title>
    <link rel="stylesheet" href="css/internal-pages.css">
    <style>
        body {
            background: #f5f7fa;
            min-height: 100vh;
        }

        .overview-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0;
        }

        .page-header {
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .page-subtitle {
            font-size: 14px;
            color: #666;
        }

        /* Balance Cards */
        .balance-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .balance-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 24px;
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.25);
            transition: transform 0.2s;
        }

        .balance-card:hover {
            transform: translateY(-4px);
        }

        .balance-card.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 4px 12px rgba(245, 87, 108, 0.25);
        }

        .balance-card.tertiary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.25);
        }

        .balance-label {
            font-size: 14px;
            font-weight: 500;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .balance-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .balance-currency {
            font-size: 14px;
            opacity: 0.8;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .stat-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1a1a1a;
        }

        .stat-change {
            font-size: 12px;
            margin-top: 4px;
        }

        .stat-change.positive {
            color: #10b981;
        }

        .stat-change.negative {
            color: #ef4444;
        }

        /* Quick Actions */
        .quick-actions {
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 16px;
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .action-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .action-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .action-title {
            font-size: 14px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .action-description {
            font-size: 12px;
            color: #666;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Error State */
        .error-state {
            background: #fee2e2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 16px;
            color: #991b1b;
            text-align: center;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .balance-cards {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .actions-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script src="js/error-handler.js?v=20251227"></script>
</head>
<body>
    <div class="overview-container">
        <div class="page-header">
            <h1 class="page-title">대시보드 개요</h1>
            <p class="page-subtitle">CoinPulse 계정 현황을 한눈에 확인하세요</p>
        </div>

        <!-- Balance Cards -->
        <div class="balance-cards">
            <div class="balance-card">
                <div class="balance-label">총 현금 잔액</div>
                <div class="balance-value" id="total-balance">-</div>
                <div class="balance-currency">KRW</div>
            </div>

            <div class="balance-card secondary">
                <div class="balance-label">주문 가능 금액</div>
                <div class="balance-value" id="available-balance">-</div>
                <div class="balance-currency">KRW</div>
            </div>

            <div class="balance-card tertiary">
                <div class="balance-label">총 자산 가치</div>
                <div class="balance-value" id="total-assets">-</div>
                <div class="balance-currency">KRW</div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">오늘 수익률</div>
                <div class="stat-value" id="daily-return">-</div>
                <div class="stat-change positive" id="daily-return-change">-</div>
            </div>

            <div class="stat-card">
                <div class="stat-label">총 수익/손실</div>
                <div class="stat-value" id="total-profit-loss">-</div>
                <div class="stat-change" id="total-pl-change">-</div>
            </div>

            <div class="stat-card">
                <div class="stat-label">보유 코인 수</div>
                <div class="stat-value" id="holdings-count">-</div>
            </div>

            <div class="stat-card">
                <div class="stat-label">진행 중인 주문</div>
                <div class="stat-value" id="active-orders">-</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <h2 class="section-title">빠른 작업</h2>
            <div class="actions-grid">
                <div class="action-card" onclick="window.location.hash = 'realtime'">
                    <div class="action-icon">📊</div>
                    <div class="action-title">대시보드</div>
                    <div class="action-description">실시간 가격 모니터링</div>
                </div>

                <div class="action-card" onclick="window.location.hash = 'trading'">
                    <div class="action-icon">📈</div>
                    <div class="action-title">차트</div>
                    <div class="action-description">실시간 차트 보기</div>
                </div>

                <div class="action-card enterprise-only" id="surge-action-card" onclick="window.location.hash = 'surge'" style="display: none;">
                    <div class="action-icon">🚀</div>
                    <div class="action-title">단타 감지</div>
                    <div class="action-description">급등 코인 실시간 모니터링</div>
                </div>

                <div class="action-card enterprise-only" id="signals-action-card" onclick="window.location.hash = 'signals'" style="display: none;">
                    <div class="action-icon">⚡</div>
                    <div class="action-title">단타 이력</div>
                    <div class="action-description">급등 신호 이력 확인</div>
                </div>

                <div class="action-card enterprise-only" id="auto-trading-action-card" onclick="window.location.hash = 'auto-trading'" style="display: none;">
                    <div class="action-icon">🤖</div>
                    <div class="action-title">단타 설정</div>
                    <div class="action-description">자동매매 알림 설정</div>
                </div>

                <div class="action-card" onclick="window.location.hash = 'portfolio'">
                    <div class="action-icon">💼</div>
                    <div class="action-title">포트폴리오</div>
                    <div class="action-description">자산 현황 보기</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Force reset API_BASE
        window.API_BASE = window.location.origin;

        // Get auth token
        function getAuthToken() {
            return localStorage.getItem('access_token') || localStorage.getItem('auth_token');
        }

        // Format number with commas
        function formatNumber(num) {
            if (num === null || num === undefined) return '0';
            return Math.round(num).toLocaleString('ko-KR');
        }

        // Load balance data
        async function loadBalanceData() {
            const token = getAuthToken();
            if (!token) {
                console.warn('[Overview] No auth token');
                return;
            }

            try {
                // Get Upbit accounts
                const response = await fetch(`${window.API_BASE}/api/upbit/accounts`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const accounts = await response.json();
                console.log('[Overview] Accounts loaded:', accounts);

                // Find KRW account
                const krwAccount = accounts.find(acc => acc.currency === 'KRW');
                if (krwAccount) {
                    const balance = parseFloat(krwAccount.balance || 0);
                    const locked = parseFloat(krwAccount.locked || 0);
                    const available = balance - locked;

                    // Update balance cards (with null checks)
                    const totalBalanceEl = document.getElementById('total-balance');
                    const availableBalanceEl = document.getElementById('available-balance');
                    if (totalBalanceEl) totalBalanceEl.textContent = formatNumber(balance);
                    if (availableBalanceEl) availableBalanceEl.textContent = formatNumber(available);
                }

                // Calculate total assets
                let totalAssets = 0;
                for (const account of accounts) {
                    const balance = parseFloat(account.balance || 0);
                    const avgBuyPrice = parseFloat(account.avg_buy_price || 0);
                    totalAssets += balance * avgBuyPrice;
                }

                const totalAssetsEl = document.getElementById('total-assets');
                if (totalAssetsEl) totalAssetsEl.textContent = formatNumber(totalAssets);

                // Update holdings count
                const holdingsCount = accounts.filter(acc => acc.currency !== 'KRW' && parseFloat(acc.balance) > 0).length;
                const holdingsCountEl = document.getElementById('holdings-count');
                if (holdingsCountEl) holdingsCountEl.textContent = holdingsCount;

            } catch (error) {
                console.error('[Overview] Error loading balance:', error);
                const totalBalanceEl = document.getElementById('total-balance');
                const availableBalanceEl = document.getElementById('available-balance');
                if (totalBalanceEl) totalBalanceEl.textContent = '오류';
                if (availableBalanceEl) availableBalanceEl.textContent = '오류';
            }
        }

        // Load stats data
        async function loadStatsData() {
            const token = getAuthToken();
            if (!token) return;

            try {
                // Get signal stats
                const response = await fetch(`${window.API_BASE}/api/user/signals/stats`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                if (data.success) {
                    const stats = data.stats;

                    // Update profit/loss (with null checks)
                    const totalPL = stats.total_profit_loss || 0;
                    const plElement = document.getElementById('total-profit-loss');
                    const plChangeElement = document.getElementById('total-pl-change');

                    if (plElement) {
                        plElement.textContent = (totalPL >= 0 ? '+' : '') + formatNumber(totalPL) + ' KRW';
                        plElement.style.color = totalPL >= 0 ? '#10b981' : '#ef4444';
                    }

                    if (plChangeElement) {
                        plChangeElement.textContent = `승률: ${stats.win_rate}%`;
                        plChangeElement.className = 'stat-change ' + (totalPL >= 0 ? 'positive' : 'negative');
                    }
                }

                // Get active orders count
                const ordersResponse = await fetch(`${window.API_BASE}/api/orders?state=wait`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (ordersResponse.ok) {
                    const ordersData = await ordersResponse.json();
                    const orders = ordersData.orders || ordersData || [];
                    const activeOrdersEl = document.getElementById('active-orders');
                    if (activeOrdersEl) activeOrdersEl.textContent = orders.length || 0;
                }

            } catch (error) {
                console.error('[Overview] Error loading stats:', error);
            }
        }

        // Check plan access for surge features
        async function checkPlanAccess() {
            try {
                const response = await fetch(`${window.API_BASE}/api/user/subscription`, {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });

                const data = await response.json();
                const plan = data?.subscription?.plan || 'free';

                console.log('[Overview] Current plan:', plan);

                const surgeCard = document.getElementById('surge-action-card');
                const signalsCard = document.getElementById('signals-action-card');
                const autoTradingCard = document.getElementById('auto-trading-action-card');

                // Free: 단타 감지만 보기 가능
                // Basic/Pro/Enterprise: 모든 단타 기능 사용 가능
                if (plan === 'free') {
                    console.log('[Overview] Free plan - showing surge monitoring only');
                    if (surgeCard) surgeCard.style.display = 'block';
                    if (signalsCard) signalsCard.style.display = 'none';
                    if (autoTradingCard) autoTradingCard.style.display = 'none';
                } else {
                    console.log(`[Overview] ${plan.toUpperCase()} plan - showing all surge features`);
                    if (surgeCard) surgeCard.style.display = 'block';
                    if (signalsCard) signalsCard.style.display = 'block';
                    if (autoTradingCard) autoTradingCard.style.display = 'block';
                }
            } catch (error) {
                console.error('[Overview] Failed to check plan:', error);
                // Show surge monitoring only by default on error
                const surgeCard = document.getElementById('surge-action-card');
                const signalsCard = document.getElementById('signals-action-card');
                const autoTradingCard = document.getElementById('auto-trading-action-card');
                if (surgeCard) surgeCard.style.display = 'block';
                if (signalsCard) signalsCard.style.display = 'none';
                if (autoTradingCard) autoTradingCard.style.display = 'none';
            }
        }

        // Initialize
        async function init() {
            console.log('[Overview] Initializing...');

            const token = getAuthToken();
            if (!token) {
                console.warn('[Overview] No auth token, redirecting to login');
                window.location.href = '/login.html';
                return;
            }

            await Promise.all([
                loadBalanceData(),
                loadStatsData(),
                checkPlanAccess()
            ]);

            // Auto-refresh every 30 seconds (only after init completes)
            setInterval(() => {
                loadBalanceData();
                loadStatsData();
            }, 30000);

            console.log('[Overview] Initialization complete');
        }

        // Initialize on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
