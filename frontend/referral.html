<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹œêµ¬ ì´ˆëŒ€í•˜ê¸° - CoinPulse</title>
    <link rel="stylesheet" href="css/internal-pages.css">
    <style>
        body {
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
        }

        .reward-highlight {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }

        .reward-highlight h3 {
            font-size: 20px;
            margin-bottom: 8px;
        }

        .reward-highlight p {
            color: rgba(255, 255, 255, 0.95);
            font-size: 14px;
        }

        /* Page-specific styles */
        .referral-code-container {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 3px solid #667eea;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }

        .referral-code-label {
            color: #666;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .referral-code {
            font-size: 36px;
            font-weight: 900;
            color: #667eea;
            letter-spacing: 3px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
        }

        .referral-link-container {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .referral-link {
            flex: 1;
            font-size: 14px;
            color: #667eea;
            word-break: break-all;
            font-family: monospace;
        }

        .copy-btn.copied {
            background: #10b981;
        }

        .recent-referrals {
            max-height: 400px;
            overflow-y: auto;
        }

        .referral-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }

        .referral-item:hover {
            background: #f8f9fa;
        }

        .referral-item:last-child {
            border-bottom: none;
        }

        .referral-info {
            flex: 1;
        }

        .referral-email {
            color: #333;
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .referral-date {
            color: #999;
            font-size: 13px;
        }

        .share-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .share-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .share-btn-kakao {
            background: #FEE500;
            color: #000000;
        }

        .share-btn-telegram {
            background: #0088cc;
            color: white;
        }

        .share-btn-twitter {
            background: #1DA1F2;
            color: white;
        }

        .share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        @media (max-width: 768px) {
            .referral-code {
                font-size: 28px;
            }

            .referral-link-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- Header -->
        <div class="page-header">
            <h1>ğŸ ì¹œêµ¬ ì´ˆëŒ€í•˜ê¸°</h1>
            <p>ì¹œêµ¬ë¥¼ ì´ˆëŒ€í•˜ê³  ì„œë¡œ ë² ì´ì§ í”Œëœ 30ì¼ ë¬´ë£Œë¥¼ ë°›ìœ¼ì„¸ìš”!</p>

            <div class="reward-highlight">
                <h3>ğŸ’ ì´ˆëŒ€ ë³´ìƒ</h3>
                <p>ì¹œêµ¬ê°€ ê°€ì…í•˜ë©´ <strong>ì¶”ì²œì¸ê³¼ ì¹œêµ¬ ëª¨ë‘</strong> ë² ì´ì§ í”Œëœ(â‚©49,000) 30ì¼ ë¬´ë£Œ í˜œíƒì´ ìë™ìœ¼ë¡œ ì§€ê¸‰ë©ë‹ˆë‹¤.</p>
            </div>
        </div>

        <!-- Referral Code Card -->
        <div class="card">
            <h2>ğŸ“‹ ë‚´ ì¶”ì²œ ì½”ë“œ</h2>

            <div class="referral-code-container">
                <div class="referral-code-label">ë‚´ ì¶”ì²œ ì½”ë“œ</div>
                <div class="referral-code" id="referral-code">ë¡œë”© ì¤‘...</div>

                <div class="referral-link-container">
                    <div class="referral-link" id="referral-link">ë¡œë”© ì¤‘...</div>
                    <button class="btn btn-primary copy-btn" id="copy-link-btn" onclick="copyReferralLink()">
                        ğŸ“‹ ë§í¬ ë³µì‚¬
                    </button>
                </div>

                <button class="btn btn-primary copy-btn" onclick="copyReferralCode()" style="width: 100%; margin-top: 10px;">
                    ğŸ“ ì½”ë“œë§Œ ë³µì‚¬
                </button>
            </div>

            <div class="share-buttons">
                <button class="share-btn share-btn-kakao" onclick="shareKakao()">
                    ğŸ’¬ ì¹´ì¹´ì˜¤í†¡ ê³µìœ 
                </button>
                <button class="share-btn share-btn-telegram" onclick="shareTelegram()">
                    âœˆï¸ í…”ë ˆê·¸ë¨ ê³µìœ 
                </button>
                <button class="share-btn share-btn-twitter" onclick="shareTwitter()">
                    ğŸ¦ íŠ¸ìœ„í„° ê³µìœ 
                </button>
            </div>
        </div>

        <!-- Statistics Card -->
        <div class="card">
            <h2>ğŸ“Š ì´ˆëŒ€ í†µê³„</h2>

            <div class="grid grid-3">
                <div class="stat-card">
                    <div class="value" id="total-referrals">0</div>
                    <div class="label">ì´ ì´ˆëŒ€ ìˆ˜</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="rewarded-referrals">0</div>
                    <div class="label">ë³´ìƒ ì§€ê¸‰ ì™„ë£Œ</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="pending-referrals">0</div>
                    <div class="label">ëŒ€ê¸° ì¤‘</div>
                </div>
            </div>
        </div>

        <!-- Recent Referrals Card -->
        <div class="card">
            <h2>ğŸ“œ ìµœê·¼ ì´ˆëŒ€ ë‚´ì—­</h2>

            <div id="recent-referrals-container" class="recent-referrals">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>ì´ˆëŒ€ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Force reset API_BASE to origin (prevent conflicts from previously loaded pages)
        window.API_BASE = window.location.origin;

        // Helper function to safely get element with retry
        async function waitForElement(elementId, maxRetries = 10, delayMs = 100) {
            for (let i = 0; i < maxRetries; i++) {
                const element = document.getElementById(elementId);
                if (element) {
                    console.log(`[Referral] Element '${elementId}' found on attempt ${i + 1}`);
                    return element;
                }
                console.log(`[Referral] Element '${elementId}' not found, retrying... (${i + 1}/${maxRetries})`);
                await new Promise(resolve => setTimeout(resolve, delayMs));
            }
            console.error(`[Referral] Element '${elementId}' not found after ${maxRetries} attempts`);
            return null;
        }

        // Get token from localStorage
        function getAuthToken() {
            return localStorage.getItem('access_token') || localStorage.getItem('auth_token');
        }

        // Global variables (use window object to avoid redeclaration errors)
        window.referralCode = window.referralCode || '';
        window.referralLink = window.referralLink || '';

        // Initialize on page load
        async function init() {
            console.log('[Referral] Initializing...');
            const token = getAuthToken();
            if (!token) {
                console.warn('[Referral] No auth token, redirecting to login');
                window.location.href = '/login.html';
                return;
            }

            console.log('[Referral] Auth token found, loading data');
            await loadReferralCode();
            await loadReferralStats();
            console.log('[Referral] Initialization complete');
        }

        // Load referral data on page load
        // Check if DOM is already loaded (for dynamic loading in dashboard)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            // DOM already loaded, call init immediately
            init();
        }

        /**
         * Load user's referral code
         */
        async function loadReferralCode() {
            console.log('[Referral] Loading referral code...');
            try {
                const token = getAuthToken();
                console.log('[Referral] Using API_BASE:', window.API_BASE);
                console.log('[Referral] Auth token:', token ? 'exists' : 'missing');

                const response = await fetch(`${window.API_BASE}/api/referral/code`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('[Referral] Code response status:', response.status);
                const data = await response.json();
                console.log('[Referral] Code response data:', data);

                if (data.success) {
                    window.referralCode = data.code;
                    window.referralLink = data.link;

                    // Wait for elements to be available
                    const codeEl = await waitForElement('referral-code');
                    const linkEl = await waitForElement('referral-link');

                    if (codeEl) {
                        codeEl.textContent = window.referralCode;
                    }
                    if (linkEl) {
                        linkEl.textContent = window.referralLink;
                    }

                    console.log('[Referral] Code loaded:', window.referralCode);
                } else {
                    throw new Error(data.error || 'Failed to load referral code');
                }
            } catch (error) {
                console.error('[Referral] Failed to load code:', error);
                const codeEl = document.getElementById('referral-code');
                const linkEl = document.getElementById('referral-link');
                if (codeEl) codeEl.textContent = 'ë¡œë“œ ì‹¤íŒ¨';
                if (linkEl) linkEl.textContent = 'í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”';
            }
        }

        /**
         * Load referral statistics
         */
        async function loadReferralStats() {
            console.log('[Referral] Loading referral stats...');
            try {
                const response = await fetch(`${window.API_BASE}/api/referral/stats`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    const stats = data.stats;

                    // Update statistics with defensive checks
                    const totalEl = document.getElementById('total-referrals');
                    const rewardedEl = document.getElementById('rewarded-referrals');
                    const pendingEl = document.getElementById('pending-referrals');

                    if (totalEl) totalEl.textContent = stats.total_referrals;
                    if (rewardedEl) rewardedEl.textContent = stats.rewarded_referrals;
                    if (pendingEl) pendingEl.textContent = stats.pending_referrals;

                    // Display recent referrals
                    displayRecentReferrals(stats.recent_referrals);

                    console.log('[Referral] Stats loaded:', stats);
                } else {
                    throw new Error(data.error || 'Failed to load stats');
                }
            } catch (error) {
                console.error('[Referral] Failed to load stats:', error);
                const container = document.getElementById('recent-referrals-container');
                if (container) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">âš ï¸</div>
                            <div class="empty-state-text">í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                            <div class="empty-state-subtext">í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”</div>
                        </div>
                    `;
                }
            }
        }

        /**
         * Display recent referrals list
         */
        function displayRecentReferrals(referrals) {
            const container = document.getElementById('recent-referrals-container');
            if (!container) {
                console.error('[Referral] recent-referrals-container not found');
                return;
            }

            if (!referrals || referrals.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ‘¥</div>
                        <div class="empty-state-text">ì•„ì§ ì´ˆëŒ€í•œ ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                        <div class="empty-state-subtext">ì¹œêµ¬ì—ê²Œ ì¶”ì²œ ë§í¬ë¥¼ ê³µìœ í•˜ì„¸ìš”!</div>
                    </div>
                `;
                return;
            }

            const html = referrals.map(referral => {
                const date = new Date(referral.created_at);
                const formattedDate = date.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                return `
                    <div class="referral-item">
                        <div class="referral-info">
                            <div class="referral-email">${referral.email}</div>
                            <div class="referral-date">${formattedDate}</div>
                        </div>
                        <div class="badge ${referral.reward_granted ? 'badge-success' : 'badge-warning'}">
                            ${referral.reward_granted ? 'âœ“ ë³´ìƒ ì§€ê¸‰ë¨' : 'â³ ëŒ€ê¸° ì¤‘'}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        /**
         * Copy referral link to clipboard
         */
        async function copyReferralLink() {
            try {
                await navigator.clipboard.writeText(window.referralLink);

                const btn = document.getElementById('copy-link-btn');
                const originalText = btn.textContent;
                btn.textContent = 'âœ“ ë³µì‚¬ë¨!';
                btn.classList.add('copied');

                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('copied');
                }, 2000);

                console.log('[Referral] Link copied to clipboard');
            } catch (error) {
                console.error('[Referral] Failed to copy link:', error);
                alert('ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
            }
        }

        /**
         * Copy referral code to clipboard
         */
        async function copyReferralCode() {
            try {
                await navigator.clipboard.writeText(window.referralCode);

                alert('âœ“ ì¶”ì²œ ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n' + window.referralCode);
                console.log('[Referral] Code copied to clipboard');
            } catch (error) {
                console.error('[Referral] Failed to copy code:', error);
                alert('ì½”ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
            }
        }

        /**
         * Share via KakaoTalk
         */
        function shareKakao() {
            const message = `ğŸ ì½”ì¸í„ìŠ¤ ì´ˆëŒ€ì¥!\n\nìë™ íŠ¸ë ˆì´ë”© í”Œë«í¼ ì½”ì¸í„ìŠ¤ì— ê°€ì…í•˜ê³  ë² ì´ì§ í”Œëœ(â‚©49,000) 30ì¼ ë¬´ë£Œë¥¼ ë°›ìœ¼ì„¸ìš”!\n\n${window.referralLink}`;

            // Check if Kakao SDK is available
            if (typeof Kakao !== 'undefined' && Kakao.isInitialized()) {
                Kakao.Link.sendDefault({
                    objectType: 'text',
                    text: message,
                    link: {
                        webUrl: window.referralLink,
                        mobileWebUrl: window.referralLink
                    }
                });
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(message);
                alert('ì¹´ì¹´ì˜¤í†¡ ê³µìœ  ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në©”ì‹œì§€ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }

        /**
         * Share via Telegram
         */
        function shareTelegram() {
            const message = encodeURIComponent(`ğŸ ì½”ì¸í„ìŠ¤ ì´ˆëŒ€ì¥!\n\nìë™ íŠ¸ë ˆì´ë”© í”Œë«í¼ ì½”ì¸í„ìŠ¤ì— ê°€ì…í•˜ê³  ë² ì´ì§ í”Œëœ(â‚©49,000) 30ì¼ ë¬´ë£Œë¥¼ ë°›ìœ¼ì„¸ìš”!\n\n${window.referralLink}`);
            window.open(`https://t.me/share/url?url=${encodeURIComponent(window.referralLink)}&text=${message}`, '_blank');
        }

        /**
         * Share via Twitter
         */
        function shareTwitter() {
            const text = encodeURIComponent(`ğŸ ì½”ì¸í„ìŠ¤ ì´ˆëŒ€ì¥! ìë™ íŠ¸ë ˆì´ë”© í”Œë«í¼ì— ê°€ì…í•˜ê³  ë² ì´ì§ í”Œëœ 30ì¼ ë¬´ë£Œë¥¼ ë°›ìœ¼ì„¸ìš”!`);
            const url = encodeURIComponent(window.referralLink);
            window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank');
        }

        // Initialize on page load - already set up in DOMContentLoaded above
    </script>
</body>
</html>
