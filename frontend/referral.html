<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>친구 초대하기 - CoinPulse</title>
    <link rel="stylesheet" href="css/internal-pages.css">
    <style>
        body {
            background: #f8f9fa;
            min-height: 100vh;
            padding: 40px 20px;
        }

        .page-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .reward-highlight {
            background: white;
            border: 2px solid #e5e7eb;
            border-left: 4px solid #667eea;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .reward-highlight h3 {
            font-size: 20px;
            margin-bottom: 8px;
            color: #1e293b;
        }

        .reward-highlight p {
            color: #64748b;
            font-size: 14px;
        }

        .reward-highlight strong {
            color: #667eea;
            font-weight: 700;
        }

        /* Page-specific styles */
        .referral-code-container {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .referral-code-label {
            color: #64748b;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .referral-code {
            font-size: 36px;
            font-weight: 900;
            color: #667eea;
            letter-spacing: 3px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
        }

        /* Statistics Grid - Horizontal Layout */
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .grid-3 {
                grid-template-columns: 1fr;
                gap: 12px;
            }
        }

        .referral-link-container {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .referral-link {
            flex: 1;
            font-size: 14px;
            color: #667eea;
            word-break: break-all;
            font-family: monospace;
        }

        .copy-btn.copied {
            background: #10b981;
        }

        .recent-referrals {
            max-height: 400px;
            overflow-y: auto;
        }

        .referral-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }

        .referral-item:hover {
            background: #f8f9fa;
        }

        .referral-item:last-child {
            border-bottom: none;
        }

        .referral-info {
            flex: 1;
        }

        .referral-email {
            color: #333;
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .referral-date {
            color: #999;
            font-size: 13px;
        }

        .share-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .share-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .share-btn-kakao {
            background: #FEE500;
            color: #000000;
        }

        .share-btn-telegram {
            background: #0088cc;
            color: white;
        }

        .share-btn-twitter {
            background: #1DA1F2;
            color: white;
        }

        .share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        @media (max-width: 768px) {
            .referral-code {
                font-size: 28px;
            }

            .referral-link-container {
                flex-direction: column;
            }
        }
    </style>
    <script src="js/error-handler.js?v=20251227"></script>
</head>
<body>
    <div class="page-container">
        <!-- Header -->
        <div class="page-header">
            <h1>🎁 친구 초대하기</h1>
            <p>친구를 초대하고 서로 베이직 플랜 30일 무료를 받으세요!</p>

            <div class="reward-highlight">
                <h3>💎 초대 보상</h3>
                <p>친구가 가입하면 <strong>추천인과 친구 모두</strong> 베이직 플랜(₩49,000) 30일 무료 혜택이 자동으로 지급됩니다.</p>
            </div>
        </div>

        <!-- Referral Code Card -->
        <div class="card">
            <h2>📋 내 추천 코드</h2>

            <div class="referral-code-container">
                <div class="referral-code-label">내 추천 코드</div>
                <div class="referral-code" id="referral-code">로딩 중...</div>

                <div class="referral-link-container">
                    <div class="referral-link" id="referral-link">로딩 중...</div>
                    <button class="btn btn-primary copy-btn" id="copy-link-btn" onclick="copyReferralLink()">
                        📋 링크 복사
                    </button>
                </div>

                <button class="btn btn-primary copy-btn" onclick="copyReferralCode()" style="width: 100%; margin-top: 10px;">
                    📝 코드만 복사
                </button>
            </div>

            <div class="share-buttons">
                <button class="share-btn share-btn-kakao" onclick="shareKakao()">
                    💬 카카오톡 공유
                </button>
                <button class="share-btn share-btn-telegram" onclick="shareTelegram()">
                    ✈️ 텔레그램 공유
                </button>
                <button class="share-btn share-btn-twitter" onclick="shareTwitter()">
                    🐦 트위터 공유
                </button>
            </div>
        </div>

        <!-- Statistics Card -->
        <div class="card">
            <h2>📊 초대 통계</h2>

            <div class="grid grid-3">
                <div class="stat-card">
                    <div class="value" id="total-referrals">0</div>
                    <div class="label">총 초대 수</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="rewarded-referrals">0</div>
                    <div class="label">보상 지급 완료</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="pending-referrals">0</div>
                    <div class="label">대기 중</div>
                </div>
            </div>
        </div>

        <!-- Recent Referrals Card -->
        <div class="card">
            <h2>📜 최근 초대 내역</h2>

            <div id="recent-referrals-container" class="recent-referrals">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>초대 내역을 불러오는 중...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Force reset API_BASE to origin (prevent conflicts from previously loaded pages)
        window.API_BASE = window.location.origin;

        // Helper function to safely get element with retry
        async function waitForElement(elementId, maxRetries = 10, delayMs = 100) {
            for (let i = 0; i < maxRetries; i++) {
                const element = document.getElementById(elementId);
                if (element) {
                    console.log(`[Referral] Element '${elementId}' found on attempt ${i + 1}`);
                    return element;
                }
                console.log(`[Referral] Element '${elementId}' not found, retrying... (${i + 1}/${maxRetries})`);
                await new Promise(resolve => setTimeout(resolve, delayMs));
            }
            console.error(`[Referral] Element '${elementId}' not found after ${maxRetries} attempts`);
            return null;
        }

        // Get token from localStorage
        function getAuthToken() {
            return localStorage.getItem('access_token') || localStorage.getItem('auth_token');
        }

        // Global variables (use window object to avoid redeclaration errors)
        window.referralCode = window.referralCode || '';
        window.referralLink = window.referralLink || '';

        // Initialize on page load
        async function init() {
            console.log('[Referral] Initializing...');
            const token = getAuthToken();
            if (!token) {
                console.warn('[Referral] No auth token, redirecting to login');
                window.location.href = '/login.html';
                return;
            }

            console.log('[Referral] Auth token found, loading data');
            await loadReferralCode();
            await loadReferralStats();
            console.log('[Referral] Initialization complete');
        }

        // Load referral data on page load
        // Check if DOM is already loaded (for dynamic loading in dashboard)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            // DOM already loaded, call init immediately
            init();
        }

        /**
         * Load user's referral code (with retry logic)
         */
        async function loadReferralCode(retryCount = 0) {
            const MAX_RETRIES = 3;
            console.log(`[Referral] Loading referral code... (attempt ${retryCount + 1}/${MAX_RETRIES + 1})`);

            try {
                const token = getAuthToken();
                console.log('[Referral] Using API_BASE:', window.API_BASE);
                console.log('[Referral] Auth token:', token ? 'exists' : 'missing');

                const response = await fetch(`${window.API_BASE}/api/referral/code`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('[Referral] Code response status:', response.status);
                const data = await response.json();
                console.log('[Referral] Code response data:', data);

                if (data.success) {
                    window.referralCode = data.code;
                    window.referralLink = data.link;

                    // Wait for elements to be available
                    const codeEl = await waitForElement('referral-code');
                    const linkEl = await waitForElement('referral-link');

                    if (codeEl) {
                        codeEl.textContent = window.referralCode;
                    }
                    if (linkEl) {
                        linkEl.textContent = window.referralLink;
                    }

                    console.log('[Referral] Code loaded successfully:', window.referralCode);
                } else {
                    throw new Error(data.error || 'Failed to load referral code');
                }
            } catch (error) {
                console.error(`[Referral] Failed to load code (attempt ${retryCount + 1}):`, error);
                console.error('[Referral] Error details:', {
                    message: error.message,
                    stack: error.stack,
                    response: error.response
                });

                // Retry logic
                if (retryCount < MAX_RETRIES) {
                    const retryDelay = 1000 * (retryCount + 1); // 1s, 2s, 3s
                    console.log(`[Referral] Retrying in ${retryDelay}ms...`);

                    const codeEl = document.getElementById('referral-code');
                    const linkEl = document.getElementById('referral-link');
                    if (codeEl) codeEl.textContent = `재시도 중... (${retryCount + 1}/${MAX_RETRIES})`;
                    if (linkEl) linkEl.textContent = '잠시만 기다려주세요...';

                    setTimeout(() => loadReferralCode(retryCount + 1), retryDelay);
                } else {
                    // Final failure after all retries
                    console.error('[Referral] All retry attempts failed');
                    const codeEl = document.getElementById('referral-code');
                    const linkEl = document.getElementById('referral-link');

                    if (codeEl) {
                        codeEl.textContent = '로드 실패';
                        codeEl.style.color = '#ef4444';
                        codeEl.style.fontSize = '18px';
                    }
                    if (linkEl) {
                        linkEl.innerHTML = `
                            <div style="color: #ef4444; margin-bottom: 10px;">
                                추천 코드를 불러올 수 없습니다.
                                <br><small>에러: ${error.message || '네트워크 오류'}</small>
                            </div>
                            <button class="btn btn-sm btn-primary" onclick="loadReferralCode(0)">다시 시도</button>
                        `;
                    }
                }
            }
        }

        /**
         * Load referral statistics
         */
        async function loadReferralStats() {
            console.log('[Referral] Loading referral stats...');
            try {
                const response = await fetch(`${window.API_BASE}/api/referral/stats`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    const stats = data.stats;

                    // Update statistics with defensive checks
                    const totalEl = document.getElementById('total-referrals');
                    const rewardedEl = document.getElementById('rewarded-referrals');
                    const pendingEl = document.getElementById('pending-referrals');

                    if (totalEl) totalEl.textContent = stats.total_referrals;
                    if (rewardedEl) rewardedEl.textContent = stats.rewarded_referrals;
                    if (pendingEl) pendingEl.textContent = stats.pending_referrals;

                    // Display recent referrals
                    displayRecentReferrals(stats.recent_referrals);

                    console.log('[Referral] Stats loaded:', stats);
                } else {
                    throw new Error(data.error || 'Failed to load stats');
                }
            } catch (error) {
                console.error('[Referral] Failed to load stats:', error);
                const container = document.getElementById('recent-referrals-container');
                if (container) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">⚠️</div>
                            <div class="empty-state-text">통계를 불러올 수 없습니다</div>
                            <div class="empty-state-subtext">페이지를 새로고침 해주세요</div>
                        </div>
                    `;
                }
            }
        }

        /**
         * Display recent referrals list
         */
        function displayRecentReferrals(referrals) {
            const container = document.getElementById('recent-referrals-container');
            if (!container) {
                console.error('[Referral] recent-referrals-container not found');
                return;
            }

            if (!referrals || referrals.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">👥</div>
                        <div class="empty-state-text">아직 초대한 친구가 없습니다</div>
                        <div class="empty-state-subtext">친구에게 추천 링크를 공유하세요!</div>
                    </div>
                `;
                return;
            }

            const html = referrals.map(referral => {
                const date = new Date(referral.created_at);
                const formattedDate = date.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                return `
                    <div class="referral-item">
                        <div class="referral-info">
                            <div class="referral-email">${referral.email}</div>
                            <div class="referral-date">${formattedDate}</div>
                        </div>
                        <div class="badge ${referral.reward_granted ? 'badge-success' : 'badge-warning'}">
                            ${referral.reward_granted ? '✓ 보상 지급됨' : '⏳ 대기 중'}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        /**
         * Copy referral link to clipboard
         */
        async function copyReferralLink() {
            try {
                await navigator.clipboard.writeText(window.referralLink);

                const btn = document.getElementById('copy-link-btn');
                const originalText = btn.textContent;
                btn.textContent = '✓ 복사됨!';
                btn.classList.add('copied');

                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('copied');
                }, 2000);

                console.log('[Referral] Link copied to clipboard');
            } catch (error) {
                console.error('[Referral] Failed to copy link:', error);
                alert('링크 복사에 실패했습니다. 수동으로 복사해주세요.');
            }
        }

        /**
         * Copy referral code to clipboard
         */
        async function copyReferralCode() {
            try {
                await navigator.clipboard.writeText(window.referralCode);

                alert('✓ 추천 코드가 복사되었습니다!\n\n' + window.referralCode);
                console.log('[Referral] Code copied to clipboard');
            } catch (error) {
                console.error('[Referral] Failed to copy code:', error);
                alert('코드 복사에 실패했습니다. 수동으로 복사해주세요.');
            }
        }

        /**
         * Share via KakaoTalk
         */
        function shareKakao() {
            const message = `🎁 코인펄스 초대장!\n\n자동 트레이딩 플랫폼 코인펄스에 가입하고 베이직 플랜(₩49,000) 30일 무료를 받으세요!\n\n${window.referralLink}`;

            // Check if Kakao SDK is available
            if (typeof Kakao !== 'undefined' && Kakao.isInitialized()) {
                Kakao.Link.sendDefault({
                    objectType: 'text',
                    text: message,
                    link: {
                        webUrl: window.referralLink,
                        mobileWebUrl: window.referralLink
                    }
                });
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(message);
                alert('카카오톡 공유 기능을 사용할 수 없습니다.\n메시지가 클립보드에 복사되었습니다.');
            }
        }

        /**
         * Share via Telegram
         */
        function shareTelegram() {
            const message = encodeURIComponent(`🎁 코인펄스 초대장!\n\n자동 트레이딩 플랫폼 코인펄스에 가입하고 베이직 플랜(₩49,000) 30일 무료를 받으세요!\n\n${window.referralLink}`);
            window.open(`https://t.me/share/url?url=${encodeURIComponent(window.referralLink)}&text=${message}`, '_blank');
        }

        /**
         * Share via Twitter
         */
        function shareTwitter() {
            const text = encodeURIComponent(`🎁 코인펄스 초대장! 자동 트레이딩 플랫폼에 가입하고 베이직 플랜 30일 무료를 받으세요!`);
            const url = encodeURIComponent(window.referralLink);
            window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank');
        }

        // Initialize on page load - already set up in DOMContentLoaded above
    </script>
</body>
</html>
