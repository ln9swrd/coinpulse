<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>대시보드 - CoinPulse</title>
    <script src="js/api_client.js?v=20251224"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Pretendard', -apple-system, sans-serif;
            background: #0a0a0f;
            color: #e0e0e0;
            padding: 20px;
        }

        .overview-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h2 {
            color: #fff;
            font-size: 24px;
            margin-bottom: 20px;
        }

        /* Subscription Card */
        .subscription-card {
            background: #1a1a2e;
            border-radius: 16px;
            padding: 32px;
            border: 2px solid #2a2a3e;
            margin-bottom: 30px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .card-header h3 {
            color: #fff;
            font-size: 20px;
            font-weight: 700;
        }

        .plan-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: #fff;
        }

        .plan-badge.free { background: #666; }
        .plan-badge.basic { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .plan-badge.pro { background: linear-gradient(135deg, #ff6b6b, #ff8e53); }
        .plan-badge.expert { background: linear-gradient(135deg, #ffd700, #ffed4e); color: #000; }
        .plan-badge.enterprise { background: linear-gradient(135deg, #9b59b6, #8e44ad); }

        .card-body {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .plan-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #2a2a3e;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-row .label {
            color: #888;
            font-size: 14px;
        }

        .info-row .value {
            color: #fff;
            font-weight: 600;
            font-size: 16px;
        }

        .info-row .value.highlight {
            color: #4facfe;
            font-size: 20px;
        }

        /* Usage Section */
        .usage-section {
            background: #0a0a0f;
            padding: 20px;
            border-radius: 12px;
        }

        .usage-section h4 {
            color: #fff;
            font-size: 16px;
            margin-bottom: 16px;
        }

        .progress-bar {
            margin-bottom: 16px;
        }

        .progress-bar:last-child {
            margin-bottom: 0;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            color: #ccc;
            font-size: 14px;
        }

        .progress {
            width: 100%;
            height: 8px;
            background: #2a2a3e;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            transition: width 0.3s;
            border-radius: 4px;
        }

        /* Card Actions */
        .card-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: #fff;
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: scale(1.02);
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid #4facfe;
            color: #4facfe;
        }

        .btn-secondary:hover {
            background: rgba(79, 172, 254, 0.1);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #666;
            color: #888;
        }

        .btn-outline:hover {
            border-color: #888;
            color: #ccc;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #333;
            border-top-color: #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: #ff6b6b;
            color: #fff;
            padding: 16px;
            border-radius: 8px;
            margin-top: 20px;
        }

        /* Quick Stats */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #1a1a2e;
            border-radius: 12px;
            padding: 24px;
            border: 2px solid #2a2a3e;
        }

        .stat-label {
            color: #888;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .stat-value {
            color: #fff;
            font-size: 28px;
            font-weight: 700;
        }

        .stat-change {
            font-size: 14px;
            margin-top: 8px;
        }

        .stat-change.positive {
            color: #51cf66;
        }

        .stat-change.negative {
            color: #ff6b6b;
        }

        @media (max-width: 768px) {
            .quick-stats {
                grid-template-columns: 1fr;
            }

            .card-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="overview-container">
        <h2>대시보드 개요</h2>

        <!-- Quick Stats -->
        <div class="quick-stats">
            <div class="stat-card">
                <div class="stat-label">현재 포트폴리오</div>
                <div class="stat-value" id="portfolio-value">-</div>
                <div class="stat-change positive" id="portfolio-change">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">진행 중인 자동매매</div>
                <div class="stat-value" id="active-bots">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">오늘의 수익</div>
                <div class="stat-value" id="today-profit">-</div>
                <div class="stat-change" id="today-profit-change">-</div>
            </div>
        </div>

        <!-- Subscription Card -->
        <div id="subscription-loading" class="loading">
            <div class="spinner"></div>
            <p style="margin-top: 16px;">구독 정보 로딩 중...</p>
        </div>

        <div id="subscription-card" class="subscription-card" style="display: none;">
            <div class="card-header">
                <h3>요금제 정보</h3>
                <span class="plan-badge" id="plan-badge">Basic</span>
            </div>

            <div class="card-body">
                <!-- 현재 플랜 -->
                <div class="plan-info">
                    <div class="info-row">
                        <span class="label">현재 플랜</span>
                        <span class="value" id="current-plan">베이직 (월간)</span>
                    </div>
                    <div class="info-row">
                        <span class="label">결제 금액</span>
                        <span class="value" id="plan-amount">39,000원/월</span>
                    </div>
                    <div class="info-row">
                        <span class="label">남은 이용일</span>
                        <span class="value highlight" id="days-remaining">7일</span>
                    </div>
                    <div class="info-row">
                        <span class="label">다음 갱신일</span>
                        <span class="value" id="next-billing">2025-12-31</span>
                    </div>
                </div>

                <!-- 사용량 -->
                <div class="usage-section">
                    <h4>사용량</h4>
                    <div class="progress-bar">
                        <div class="progress-label">
                            <span>투자조언 코인</span>
                            <span id="coins-usage">0/5</span>
                        </div>
                        <div class="progress">
                            <div class="progress-fill" id="coins-progress" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-label">
                            <span>급등 알림 (이번 주)</span>
                            <span id="alerts-usage">0/5</span>
                        </div>
                        <div class="progress">
                            <div class="progress-fill" id="alerts-progress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- 액션 버튼 -->
                <div class="card-actions">
                    <a href="/subscription_manage.html" class="btn btn-primary">
                        플랜 변경
                    </a>
                    <a href="/subscription_extend.html" class="btn btn-secondary">
                        사용기간 연장
                    </a>
                    <button class="btn btn-outline" onclick="showPaymentHistory()">
                        결제 내역
                    </button>
                </div>
            </div>
        </div>

        <div id="subscription-error" style="display: none;">
            <div class="error-message">
                <strong>오류:</strong> <span id="error-text"></span>
            </div>
        </div>
    </div>

    <script>
        // Load subscription data on page load
        window.addEventListener('DOMContentLoaded', async () => {
            await loadSubscriptionData();
            loadQuickStats(); // Placeholder for now
        });

        async function loadSubscriptionData() {
            const loading = document.getElementById('subscription-loading');
            const card = document.getElementById('subscription-card');
            const error = document.getElementById('subscription-error');

            try {
                const response = await window.api.authenticatedRequest('/api/subscription/current');

                if (!response.success) {
                    throw new Error(response.error || 'Failed to load subscription');
                }

                const { subscription, plan_features, usage } = response;

                // Update plan badge
                const planBadge = document.getElementById('plan-badge');
                planBadge.textContent = subscription.plan_name_ko;
                planBadge.className = `plan-badge ${subscription.plan}`;

                // Update plan info
                const billingText = subscription.billing_period === 'monthly' ? '월간' :
                                    subscription.billing_period === 'yearly' ? '연간' : '';
                document.getElementById('current-plan').textContent = `${subscription.plan_name_ko} ${billingText ? `(${billingText})` : ''}`;

                if (subscription.amount > 0) {
                    const periodText = subscription.billing_period === 'monthly' ? '월' : '년';
                    document.getElementById('plan-amount').textContent = `₩${subscription.amount.toLocaleString()}/${periodText}`;
                } else {
                    document.getElementById('plan-amount').textContent = '무료';
                }

                if (subscription.days_remaining !== null) {
                    document.getElementById('days-remaining').textContent = `${subscription.days_remaining}일`;
                } else {
                    document.getElementById('days-remaining').textContent = '무제한';
                }

                if (subscription.next_billing_date) {
                    const date = new Date(subscription.next_billing_date);
                    document.getElementById('next-billing').textContent = date.toLocaleDateString('ko-KR');
                } else {
                    document.getElementById('next-billing').textContent = '-';
                }

                // Update usage
                const maxCoins = plan_features.max_advisory_coins || 0;
                const coinsUsed = usage.advisory_coins_used || 0;
                document.getElementById('coins-usage').textContent = maxCoins > 0 ? `${coinsUsed}/${maxCoins}` : '무제한';
                document.getElementById('coins-progress').style.width = maxCoins > 0 ? `${(coinsUsed / maxCoins) * 100}%` : '0%';

                const maxAlerts = plan_features.max_surge_alerts || 0;
                const alertsUsed = usage.surge_alerts_used || 0;
                document.getElementById('alerts-usage').textContent = maxAlerts > 0 ? `${alertsUsed}/${maxAlerts}` : '무제한';
                document.getElementById('alerts-progress').style.width = maxAlerts > 0 ? `${(alertsUsed / maxAlerts) * 100}%` : '0%';

                // Show card, hide loading
                loading.style.display = 'none';
                card.style.display = 'block';

            } catch (err) {
                console.error('Failed to load subscription:', err);
                loading.style.display = 'none';
                error.style.display = 'block';
                document.getElementById('error-text').textContent = err.message;
            }
        }

        function loadQuickStats() {
            // TODO: Load real data from API
            document.getElementById('portfolio-value').textContent = '₩12,345,678';
            document.getElementById('portfolio-change').textContent = '+5.2%';
            document.getElementById('active-bots').textContent = '3개';
            document.getElementById('today-profit').textContent = '₩125,000';
            document.getElementById('today-profit-change').textContent = '+12.5%';
            document.getElementById('today-profit-change').className = 'stat-change positive';
        }

        function showPaymentHistory() {
            alert('결제 내역 기능은 준비 중입니다.');
            // TODO: Implement payment history modal
        }
    </script>
</body>
</html>
